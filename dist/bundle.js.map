{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///./src/baka_link.js","webpack:///./src/document.js","webpack:///./src/editable.js","webpack:///./src/index.js","webpack:///./src/markdown_document.js","webpack:///./src/utils.js"],"names":["BakaLink","observer","MutationObserver","mutations","querySelector","update","observe","childList","el","document","createElement","href","innerText","target","innerHTML","appendChild","HTMLElement","customElements","define","Document","historyOffset","history","length","type","item","start","value","insert","replace","from","fireUpdate","n","dir","end","text","styleName","range","offset","styles","i","ranges","push","historyItem","save","beforeInsert","arr","Array","splice","join","slice","to","beforeDelete","event","callback","listeners","callbacks","forEach","allRanges","lines","nodes","result","style","getStylesAtOffset","filter","rangeData","map","stylesEqual","a","b","indexOf","currentNode","currentLine","ch","subtractArray","x","y","reversed","myArr","reverse","sortedByPriority","asc","newArr","sort","aPriority","priority","bPriority","undefined","activeStyles","Set","node","diff","minIndex","reduce","accumulator","index","size","stylesToClose","stylesToOpen","add","openTag","prevEnd","closeTag","escapeHtml","endsWith","Editable","setAttribute","addEventListener","focus","io","toHtml","data","console","log","lastSelection","getSelection","updated","revertedItem","setCursorPos","saveSelection","e","ctrlKey","shiftKey","keyCode","preventDefault","undo","redo","m","before","after","cursorPos","collapsed","startOffset","change","endOffset","subtree","characterData","childNodes","nodeName","flat","Infinity","container","firstChild","getFlatNodes","lastNode","line","activeElement","containerData","getContainerAtOffset","window","getRangeAt","err","setEnd","setStart","caretOffset","selected","toString","preCaretRange","cloneRange","selectNodeContents","endContainer","brCount","cloneContents","querySelectorAll","startContainer","firstOffset","getContainerOffset","secondOffset","__cursorPos","val","__cursorPosListeners","cb","setTimeout","BakaEditor","name","oldValue","newValue","debug","getAttribute","elms","placeholder","outputContainer","originalOutputContainer","template","wrapper","editor","onTextUpdate","bind","logger","updatePlaceholder","initEditor","initButtons","buttons","bold","italic","strike","underline","monospace","quote","code","header_first","header_second","popupButtons","link","image","onPopupButtonClick","button","popup","urlInput","titleInput","closePopup","keydownListener","classList","remove","removeEventListener","getMarkup","onKeydown","key","markup","onDocumentClick","toggle","contains","onButtonClick","mark","historyEvent","toUpperCase","setText","getFinalHtml","dispatchEvent","CustomEvent","detail","original","html","initIO","MarkdownDocument","link_titles","linkCounter","full","image_titles","title","imageCounter","Object","keys","block","RegExp","service","image_title","link_title","process","styleNames","regexp","trigger","fullMatch","match","escapedTrigger","processOneLine","processLinks","processImages","linkStart","linkEnd","replaced_occurrences","escapeMarkup","unsafe"],"mappings":"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","file":"bundle.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = \"./src/index.js\");\n","// @flow\r\n\r\nexport default class BakaLink extends HTMLElement {\r\n    connectedCallback(): void {\r\n        const observer = new MutationObserver((mutations) => {\r\n            if (this.querySelector('a')) return\r\n            this.update()\r\n        })\r\n\r\n        observer.observe(this, { childList: true })\r\n\r\n        this.update()\r\n    }\r\n\r\n    update() {\r\n        const el = document.createElement('a')\r\n        el.href = this.innerText\r\n        el.target = '_blank'\r\n        el.innerText = this.innerText\r\n        this.innerHTML = ''\r\n        this.appendChild(el)\r\n    }\r\n}\r\n\r\ncustomElements.define('baka-link', BakaLink)\r\n","// @flow\n\nimport { escapeHtml } from './utils'\n\ntype InsertEvent = {\n    type: 'insert',\n    start: number,\n    value: string,\n}\n\ntype DeleteEvent = {\n    type: 'delete',\n    start: number,\n    n: number,\n    value: string,\n    dir: 'back' | 'forward',\n}\n\ntype ReplaceEvent = {\n    type: 'replace',\n    start: number,\n    end: number,\n    from: string,\n    to: string,\n}\n\ntype SetTextEvent = {\n    type: 'set text',\n    text: string,\n}\n\ntype MyNode = {\n    styles: string[],\n    text: string,\n    start: number,\n    end: number,\n}\n\nexport interface IO {\n    text: string;\n    styles: {\n        [string]: {\n            openTag: string,\n            closeTag: string,\n            ranges: [[number, number]],\n        },\n    };\n\n    history: Array<InsertEvent | DeleteEvent | SetTextEvent | ReplaceEvent>;\n    addEventListener: (\n        event: string,\n        item: InsertEvent | DeleteEvent | SetTextEvent | ReplaceEvent\n    ) => {};\n\n    undo(): void;\n    redo(): void;\n\n    delete(start: number, n: number, direction?: string): void;\n    insert(start: number, text: string): void;\n    replace(start: number, end: number, text: string): void;\n\n    mark(styleName: string, range: [number, number]): number;\n\n    toHtml(): string;\n}\n\nexport default class Document {\n    text = ''\n    history: Array<InsertEvent | DeleteEvent | SetTextEvent | ReplaceEvent> = []\n    historyOffset: number = -1\n\n    undo() {\n        if (\n            this.historyOffset === this.history.length - 1 ||\n            this.history[this.history.length - this.historyOffset - 2].type ===\n                'set text'\n        )\n            return\n        this.historyOffset += 1\n        let item = this.history[this.history.length - this.historyOffset - 1]\n\n        switch (item.type) {\n            case 'insert':\n                this.delete(item.start, item.value.length, 'back', false)\n                break\n            case 'delete':\n                this.insert(item.start, item.value, false)\n                break\n            case 'replace':\n                this.replace(\n                    item.start,\n                    item.start + item.from.length,\n                    item.from,\n                    false\n                )\n                break\n        }\n        this.fireUpdate(item, 'undo')\n    }\n\n    redo() {\n        if (this.historyOffset === -1) return\n        let item = this.history[this.history.length - this.historyOffset - 1]\n        this.historyOffset -= 1\n\n        switch (item.type) {\n            case 'insert':\n                this.insert(item.start, item.value, false)\n                break\n            case 'delete':\n                this.delete(item.start, item.n, item.dir, false)\n                break\n            case 'replace':\n                this.replace(item.start, item.end, item.value)\n                break\n        }\n        this.fireUpdate(item, 'redo')\n    }\n\n    beforeDelete(start: number, n: number) {}\n    beforeInsert(start: number, text: string) {}\n\n    mark(styleName: string, range: [number, number]): number {}\n\n    getStylesAtOffset(offset: number) {\n        let styles = {}\n        for (let styleName in this.styles) {\n            for (let i = 0; i < this.styles[styleName].ranges.length; i++) {\n                let range = this.styles[styleName].ranges[i]\n                if (!(range[0] < offset && range[1] >= offset)) continue\n                styles[styleName] = range\n            }\n        }\n        return styles\n    }\n\n    getStylesAtRange(start: number, end: number) {\n        let styles = []\n        for (let styleName in this.styles) {\n            for (let i = 0; i < this.styles[styleName].ranges.length; i++) {\n                let range = this.styles[styleName].ranges[i]\n                if (\n                    !(\n                        (\n                            (range[0] >= start && range[0] < end) || // Начало в выделении\n                            (range[1] > start && range[1] <= end) || // Конец в выделении\n                            (range[0] <= start && range[1] >= end)\n                        ) // Выделение между началом и концом\n                    )\n                )\n                    continue\n                styles.push(styleName)\n            }\n        }\n        return styles\n    }\n\n    setText(text) {\n        const historyItem: SetTextEvent = { type: 'set text', text }\n        this.history = [historyItem]\n        this.text = text\n        this.fireUpdate(historyItem)\n    }\n\n    insert(\n        start: number,\n        value: string,\n        save: boolean = true,\n        update: bolean = true\n    ): void {\n        const historyItem: InsertEvent = { type: 'insert', value, start }\n        if (save) {\n            this.history.push(historyItem)\n            this.historyOffset = -1\n        }\n\n        this.beforeInsert(start, value)\n\n        let arr = Array.from(this.text)\n        arr.splice(start, 0, value)\n        this.text = arr.join('')\n\n        if (update) this.fireUpdate(historyItem)\n    }\n\n    replace(\n        start: number,\n        end: number,\n        value: string,\n        save: boolean = true,\n        update: boolean = true\n    ): void {\n        const historyItem: ReplaceEvent = {\n            type: 'replace',\n            start,\n            end,\n            from: this.text.slice(start, end),\n            to: value,\n        }\n        if (save) {\n            this.history.push(historyItem)\n            this.historyOffset = -1\n        }\n        this.delete(start, end - start, 'back', false, false)\n        if (value) this.insert(start, value, false, false)\n        if (update) this.fireUpdate(historyItem)\n    }\n\n    delete(\n        start: number,\n        n: number,\n        dir: 'back' | 'forward' = 'back',\n        save: boolean = true,\n        update: boolean = true\n    ) {\n        const historyItem: DeleteEvent = {\n            type: 'delete',\n            n,\n            start,\n            dir,\n            value: this.text.slice(start, start + n),\n        }\n        if (save) {\n            this.history.push(historyItem)\n            this.historyOffset = -1\n        }\n\n        this.beforeDelete(start, n)\n\n        let arr = Array.from(this.text)\n        arr.splice(start, n)\n        this.text = arr.join('')\n\n        if (update) this.fireUpdate(historyItem)\n    }\n\n    listeners: { [string]: Array<(event: mixed) => void> } = {}\n\n    addEventListener(event: string, callback: (event: mixed) => void): void {\n        if (this.listeners[event]) {\n            this.listeners[event].push(callback)\n        } else {\n            this.listeners[event] = [callback]\n        }\n    }\n\n    fireUpdate(event: mixed, type: string = 'update'): void {\n        const callbacks = this.listeners[type]\n        if (!callbacks) return\n        callbacks.forEach((callback) => callback(event))\n    }\n\n    toHtml(): string {\n        if (!this.text.length) return ''\n        let allRanges: Array<{ style: string, range: [number, number] }> = []\n        let lines = [[]]\n        let nodes: Array<MyNode> = []\n        let result = ''\n\n        for (let styleName in this.styles) {\n            for (let range of this.styles[styleName].ranges) {\n                allRanges.push({ style: styleName, range })\n            }\n        }\n\n        const getStylesAtOffset = (offset: number): string[] => {\n            return allRanges\n                .filter((rangeData) => {\n                    let range = rangeData.range\n                    return range[0] <= offset && range[1] > offset\n                })\n                .map((rangeData) => rangeData.style)\n        }\n\n        const stylesEqual = (a: string[], b: string[]) => {\n            if (a.length !== b.length) return false\n            return !a.filter((el) => b.indexOf(el) < 0).length\n        }\n\n        let currentNode: MyNode = {\n            styles: getStylesAtOffset(0),\n            text: this.text[0],\n            start: 0,\n            end: 1,\n        }\n        let currentLine = 0\n        for (let i = 1; i < this.text.length; i++) {\n            let ch = this.text[i]\n            let styles = getStylesAtOffset(i)\n\n            if (stylesEqual(currentNode.styles, styles)) {\n                currentNode.end = i\n                currentNode.text += ch\n                continue\n            }\n\n            lines[currentLine].push(currentNode)\n            nodes.push(currentNode)\n            if (ch === '\\n') {\n                currentLine++\n                lines.push([])\n                // continue\n            }\n            currentNode = {\n                styles,\n                text: ch,\n                start: i,\n                end: i + 1,\n            }\n        }\n        lines[currentLine].push(currentNode)\n        nodes.push(currentNode)\n\n        const subtractArray = (x, y) => {\n            return x.filter((el) => y.indexOf(el) < 0)\n        }\n\n        const reversed = (arr) => {\n            let myArr = [...arr]\n            myArr.reverse()\n            return myArr\n        }\n\n        const sortedByPriority = (arr: Array<string>, asc: boolean = false) => {\n            let newArr = [...arr]\n            newArr.sort((a, b) => {\n                let aPriority = this.styles[a].priority\n                let bPriority = this.styles[b].priority\n                if (aPriority === undefined) aPriority = 0\n                if (bPriority === undefined) bPriority = 0\n                return asc ? aPriority - bPriority : bPriority - aPriority\n            })\n            return newArr\n        }\n\n        let activeStyles = new Set()\n        for (let node of nodes) {\n            const diff = subtractArray([...activeStyles], node.styles)\n            const minIndex = diff.reduce((accumulator, styleName) => {\n                const index = [...activeStyles].indexOf(styleName)\n                if (index < accumulator) return index\n            }, activeStyles.size)\n            const stylesToClose = reversed(\n                [...activeStyles].slice(minIndex, activeStyles.size)\n            )\n            stylesToClose.forEach((styleName) => activeStyles.delete(styleName))\n\n            const stylesToOpen = sortedByPriority(\n                subtractArray(node.styles, [...activeStyles])\n            )\n            stylesToOpen.forEach((styleName) => activeStyles.add(styleName))\n\n            let start = stylesToOpen\n                .map((styleName) => this.styles[styleName].openTag)\n                .join('')\n            let prevEnd = stylesToClose\n                .map((styleName) => this.styles[styleName].closeTag)\n                .join('')\n            result += prevEnd + start + escapeHtml(node.text)\n        }\n\n        result += reversed([...activeStyles])\n            .map((styleName) => this.styles[styleName].closeTag)\n            .join('')\n\n        if (result.endsWith('\\n') || result.endsWith('<br/>'))\n            result += '&#8203;'\n\n        result = result.replace(/\\r/gm, '')\n        // console.log(result)\n        return result\n    }\n}\n","// @flow\n\nimport type IO from './document'\n\ntype CustomSelection = {\n    startOffset: number,\n    endOffset: number,\n\n    startContainer: Node,\n    endContainer: Node,\n\n    toString: () => string,\n    collapsed: boolean,\n}\n\nclass Editable extends HTMLElement {\n    connectedCallback(): void {\n        this.setAttribute('contenteditable', 'true')\n        this.addEventListener('click', () => this.focus())\n    }\n\n    updated = false\n    range: CustomSelection = {}\n    lastSelection: CustomSelection = {}\n\n    initIO(io: IO): void {\n        this.innerHTML = io.toHtml()\n\n        io.addEventListener('update', (data) => {\n            console.log(data)\n            this.innerHTML = io.toHtml()\n            this.lastSelection = this.getSelection()\n            if (this.innerText) this.updated = true\n        })\n\n        io.addEventListener('undo', (revertedItem) => {\n            console.log('Undo', revertedItem)\n            if (revertedItem.type === 'insert') {\n                this.setCursorPos(revertedItem.start)\n            }\n\n            if (revertedItem.type === 'delete') {\n                this.setCursorPos(revertedItem.start + revertedItem.n)\n            }\n        })\n\n        io.addEventListener('redo', (revertedItem) => {\n            console.log('Redo', revertedItem)\n            if (revertedItem.type === 'insert') {\n                this.setCursorPos(\n                    revertedItem.start + revertedItem.value.length\n                )\n            }\n\n            if (revertedItem.type === 'delete') {\n                this.setCursorPos(revertedItem.start)\n            }\n        })\n\n        const saveSelection = () => {\n            this.lastSelection = this.getSelection()\n        }\n\n        this.addEventListener('keyup', saveSelection)\n        this.addEventListener('keydown', saveSelection)\n        this.addEventListener('click', saveSelection)\n\n        this.addEventListener('keydown', (e: KeyboardEvent) => {\n            // e.keyCode 90 = 'z'\n            if (!e.ctrlKey || e.shiftKey || e.keyCode !== 90) return\n            e.preventDefault()\n            io.undo()\n            this.updated = true\n        })\n\n        this.addEventListener('keydown', (e: KeyboardEvent) => {\n            // e.keyCode 90 = 'z'\n            if (!e.ctrlKey || !e.shiftKey || e.keyCode !== 90) return\n            e.preventDefault()\n            io.redo()\n            this.updated = true\n        })\n\n        this.addEventListener('keydown', (e: KeyboardEvent) => {\n            // e.keyCode 89 = 'y'\n            if (!e.ctrlKey || e.shiftKey || e.keyCode !== 89) return\n            e.preventDefault()\n            io.redo()\n            this.updated = true\n        })\n\n        const callback = (m) => {\n            console.log(m)\n            const before = io.text\n            const after = this.innerText\n\n            const range = this.getSelection()\n\n            if (this.updated) {\n                console.log('IGNORED')\n                this.setCursorPos(this.cursorPos)\n                this.updated = false\n                return\n            }\n\n            console.log('USED')\n\n            if (this.lastSelection.collapsed) {\n                if (before.length < after.length) {\n                    const start = this.lastSelection.startOffset\n                    const end = start + (after.length - before.length)\n                    let change = this.innerText.slice(start, end)\n                    if (change === '\\n\\n') change = '\\n'\n                    io.insert(start, change)\n                    this.cursorPos = start + change.length\n                } else {\n                    let start = range.startOffset\n                    let end = this.lastSelection.startOffset\n                    if (end - start < 0) {\n                        end = this.lastSelection.startOffset\n                        start = this.lastSelection.startOffset - 1\n                    }\n                    io.delete(start, end - start)\n                    this.cursorPos = start\n                }\n            } else {\n                console.log(this.lastSelection)\n                const start = this.lastSelection.startOffset\n                const end = this.lastSelection.endOffset\n                const value = this.innerText.slice(start, range.startOffset)\n                io.replace(start, end, value)\n                this.cursorPos = range.startOffset\n            }\n\n            this.setCursorPos(this.cursorPos)\n\n            saveSelection()\n        }\n\n        const observer = new MutationObserver(callback)\n        observer.observe(this, {\n            childList: true,\n            subtree: true,\n            characterData: true,\n        })\n    }\n\n    __cursorPos = 0\n    __cursorPosListeners = []\n    get cursorPos() {\n        return this.__cursorPos\n    }\n    set cursorPos(val: number): void {\n        this.__cursorPos = val\n        this.__cursorPosListeners.forEach((cb) => setTimeout(() => cb(val), 1))\n    }\n\n    getFlatNodes() {\n        let nodes: Array<any> = Array.from(this.childNodes)\n        while (nodes.filter((node) => node.childNodes.length).length) {\n            nodes = nodes\n                .map((el: Node) =>\n                    el.nodeName === '#text' || el.nodeName === 'BR'\n                        ? [el]\n                        : Array.from(el.childNodes)\n                )\n                .flat(Infinity)\n        }\n        return nodes\n    }\n\n    getContainerOffset(container: HTMLElement): number {\n        while (\n            container.nodeName !== '#text' &&\n            container.firstChild !== null\n        ) {\n            container = container.firstChild\n        }\n        const nodes = this.getFlatNodes()\n\n        let offset = 0\n        for (let node of nodes) {\n            if (node === container) {\n                break\n            }\n            offset += node.length || 1\n        }\n\n        return offset\n    }\n\n    getContainerAtOffset(offset: number): { line: Node, n: number } {\n        const nodes = this.getFlatNodes()\n\n        let lastNode: Node | void = undefined\n        let x = 0\n        for (let node of nodes) {\n            if (node.nodeName === 'BR') {\n                x += 1\n                continue\n            }\n            if (node.nodeName !== '#text') {\n                if (!node.firstChild) continue\n                node = node.firstChild\n            }\n            lastNode = node\n            if (x + (node.length || 1) >= offset) break\n            x += node.length || 1\n        }\n        return { line: lastNode || nodes[0], n: x }\n    }\n\n    setCursorPos(offset: number): void {\n        if (document.activeElement !== this) return\n        let containerData = this.getContainerAtOffset(offset)\n        let node = containerData.line\n        let n = containerData.n\n\n        if (!node) return\n\n        if (node.firstChild) node = node.firstChild\n\n        let range\n        try {\n            range = window.getSelection().getRangeAt(0)\n        } catch (err) {\n            return\n        }\n        // console.log(offset - n, offset, n)\n        range.setEnd(node, offset - n)\n        range.setStart(node, offset - n)\n        this.cursorPos = offset\n    }\n\n    getCursorPos(): number {\n        let caretOffset = 0\n        let range\n        try {\n            range = window.getSelection().getRangeAt(0)\n        } catch (err) {\n            return 0\n        }\n        let selected = range.toString().length\n        let preCaretRange = range.cloneRange()\n\n        preCaretRange.selectNodeContents(this)\n        preCaretRange.setEnd(range.endContainer, range.endOffset)\n        caretOffset = preCaretRange.toString().length - selected\n\n        const brCount = Array.from(preCaretRange.cloneContents().childNodes)\n            .map((el: HTMLElement) =>\n                el.nodeName === '#text'\n                    ? []\n                    : Array.from(el.querySelectorAll('*'))\n            )\n            .flat(Infinity)\n            .filter((el: any) => el.nodeName === 'BR').length\n        caretOffset += brCount\n\n        return caretOffset\n    }\n\n    getSelection(): CustomSelection {\n        let range\n        try {\n            range = window.getSelection().getRangeAt(0)\n        } catch (err) {\n            return {\n                startOffset: 0,\n                endOffset: 0,\n                startContainer: this,\n                endContainer: this,\n                collapsed: true,\n                toString: () => '',\n            }\n        }\n        let result: CustomSelection = {}\n        let firstOffset = this.getContainerOffset(range.startContainer)\n        let secondOffset = this.getContainerOffset(range.endContainer)\n\n        result.toString = () => range.toString()\n\n        result.collapsed = range.collapsed\n\n        result.startContainer = range.startContainer\n        result.startOffset = range.startOffset + firstOffset\n\n        result.endContainer = range.endContainer\n        result.endOffset = range.endOffset + secondOffset\n\n        if (\n            range.startContainer === this &&\n            range.endContainer === this &&\n            range.startOffset === 0 &&\n            range.endOffset === 1\n        ) {\n            result.startOffset = 0\n            result.endOffset = this.innerText.length\n        }\n\n        return result\n    }\n}\n\ncustomElements.define('baka-editable', Editable)\n","// @flow\r\n\r\nimport Document from './markdown_document'\r\nimport Editable from './editable'\r\nimport BakaLink from './baka_link'\r\n\r\nclass BakaEditor extends HTMLElement {\r\n    template = `<div id=\"wrapper\">\r\n        <div id=\"buttons\">\r\n            <a href=\"#\" id=\"bold\" tabindex=\"-1\">B</a>\r\n            <a href=\"#\" id=\"italic\" tabindex=\"-1\">I</a>\r\n            <a href=\"#\" id=\"strike\" tabindex=\"-1\">S</a>\r\n            <a href=\"#\" id=\"underline\" tabindex=\"-1\">U</a>\r\n            <a href=\"#\" id=\"monospace\" tabindex=\"-1\">M</a>\r\n            <a href=\"#\" id=\"quote\" tabindex=\"-1\">&laquo;&raquo;</a>\r\n            <a href=\"#\" id=\"code\" tabindex=\"-1\">&lt;/&gt;</a>\r\n            <a href=\"#\" id=\"header_first\" tabindex=\"-1\">H1</a>\r\n            <a href=\"#\" id=\"header_second\" tabindex=\"-1\">H2</a>\r\n            <div class=\"delimiter\"></div>\r\n            <a href=\"#\" id=\"link\" tabindex=\"-1\">\r\n                <svg aria-hidden=\"true\" focusable=\"false\" data-prefix=\"fas\" data-icon=\"link\" class=\"svg-inline--fa fa-link fa-w-16\" role=\"img\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 512 512\"><path fill=\"rgba(0, 0, 255, 0.3)\" d=\"M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 0 1-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0 1 20.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0 0 20.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 0 0-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z\"></path></svg>\r\n                <div class=\"popup\" id=\"link_popup\">\r\n                    <input type=\"text\" placeholder=\"URL\" class=\"url\" />\r\n                    <input type=\"text\" placeholder=\"Title\" class=\"title\" />\r\n                </div>\r\n            </a>\r\n            <a href=\"#\" id=\"image\" tabindex=\"-1\">\r\n                <svg aria-hidden=\"true\" focusable=\"false\" data-prefix=\"far\" data-icon=\"image\" class=\"svg-inline--fa fa-image fa-w-16\" role=\"img\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 512 512\"><path fill=\"rgba(0, 0, 255, 0.3)\" d=\"M464 64H48C21.49 64 0 85.49 0 112v288c0 26.51 21.49 48 48 48h416c26.51 0 48-21.49 48-48V112c0-26.51-21.49-48-48-48zm-6 336H54a6 6 0 0 1-6-6V118a6 6 0 0 1 6-6h404a6 6 0 0 1 6 6v276a6 6 0 0 1-6 6zM128 152c-22.091 0-40 17.909-40 40s17.909 40 40 40 40-17.909 40-40-17.909-40-40-40zM96 352h320v-80l-87.515-87.515c-4.686-4.686-12.284-4.686-16.971 0L192 304l-39.515-39.515c-4.686-4.686-12.284-4.686-16.971 0L96 304v48z\"></path></svg>\r\n                <div class=\"popup\" id=\"link_popup\">\r\n                    <input type=\"text\" placeholder=\"URL\" class=\"url\" />\r\n                    <input type=\"text\" placeholder=\"Title\" class=\"title\" />\r\n                </div>\r\n            </a>\r\n            \r\n        </div>\r\n        <div id=\"placeholder\">Type: Echo!</div>\r\n        <baka-editable id=\"editor\" />\r\n    </div>`\r\n\r\n    debug = false\r\n\r\n    elms: {\r\n        editor: Editable,\r\n        placeholder: HTMLElement,\r\n        wrapper: HTMLElement,\r\n        buttons: {\r\n            [string]: HTMLElement,\r\n        },\r\n        popupButtons: {\r\n            [string]: HTMLElement,\r\n        },\r\n    } = {}\r\n\r\n    outputContainer: HTMLElement | void | null\r\n    originalOutputContainer: HTMLElement | void | null\r\n\r\n    static get observedAttributes() {\r\n        return ['placeholder', 'output', 'originaloutput', 'debug']\r\n    }\r\n\r\n    attributeChangedCallback(name, oldValue, newValue) {\r\n        switch (name) {\r\n            case 'debug':\r\n                this.debug = this.getAttribute('debug') !== null\r\n            case 'placeholder':\r\n                if (!this.elms.placeholder) break\r\n                this.elms.placeholder.innerHTML = newValue\r\n                break\r\n            case 'output':\r\n                this.outputContainer = document.querySelector(\r\n                    this.getAttribute('output')\r\n                )\r\n                break\r\n            case 'originaloutput':\r\n                this.originalOutputContainer = document.querySelector(\r\n                    this.getAttribute('originaloutput')\r\n                )\r\n                break\r\n        }\r\n    }\r\n\r\n    connectedCallback() {\r\n        this.innerHTML = this.template\r\n\r\n        this.debug = this.getAttribute('debug') !== null\r\n\r\n        this.outputContainer = document.querySelector(\r\n            this.getAttribute('output')\r\n        )\r\n\r\n        this.elms.wrapper = this.querySelector('#wrapper')\r\n        this.elms.editor = this.querySelector('#editor')\r\n\r\n        this.elms.placeholder = this.querySelector('#placeholder')\r\n        if (this.getAttribute('placeholder'))\r\n            this.elms.placeholder.innerHTML = this.getAttribute('placeholder')\r\n\r\n        this.document = new Document()\r\n        this.document.addEventListener('update', this.onTextUpdate.bind(this))\r\n        this.document.addEventListener('update', this.logger.bind(this))\r\n\r\n        this.updatePlaceholder()\r\n        this.initEditor()\r\n        this.initButtons()\r\n\r\n        this.logger({ type: 'INIT' })\r\n    }\r\n\r\n    initButtons() {\r\n        this.elms.buttons = {\r\n            wrapper: this.elms.wrapper.querySelector('#buttons'),\r\n            bold: this.elms.wrapper.querySelector('#buttons #bold'),\r\n            italic: this.elms.wrapper.querySelector('#buttons #italic'),\r\n            strike: this.elms.wrapper.querySelector('#buttons #strike'),\r\n            underline: this.elms.wrapper.querySelector('#buttons #underline'),\r\n            monospace: this.elms.wrapper.querySelector('#buttons #monospace'),\r\n            quote: this.elms.wrapper.querySelector('#buttons #quote'),\r\n            code: this.elms.wrapper.querySelector('#buttons #code'),\r\n            header_first: this.elms.wrapper.querySelector(\r\n                '#buttons #header_first'\r\n            ),\r\n            header_second: this.elms.wrapper.querySelector(\r\n                '#buttons #header_second'\r\n            ),\r\n        }\r\n\r\n        this.elms.popupButtons = {\r\n            link: this.elms.wrapper.querySelector('#buttons #link'),\r\n            image: this.elms.wrapper.querySelector('#buttons #image'),\r\n        }\r\n\r\n        const onPopupButtonClick = (\r\n            styleName: 'link' | 'image',\r\n            e: MouseEvent\r\n        ) => {\r\n            const button = this.elms.popupButtons[styleName]\r\n            const popup = button.querySelector('.popup')\r\n            const urlInput = popup.querySelector('input.url')\r\n            const titleInput = popup.querySelector('input.title')\r\n\r\n            if ([popup, urlInput, titleInput].indexOf(e.target) >= 0) {\r\n                e.preventDefault()\r\n                return\r\n            }\r\n\r\n            const closePopup = (keydownListener?: () => {}) => {\r\n                urlInput.value = ''\r\n                titleInput.value = ''\r\n                button.classList.remove('active')\r\n                if (keydownListener) {\r\n                    urlInput.removeEventListener('keydown', keydownListener)\r\n                    titleInput.removeEventListener('keydown', keydownListener)\r\n                }\r\n            }\r\n\r\n            const getMarkup = (styleName: 'link' | 'image') => {\r\n                if (styleName === 'link') {\r\n                    return `[${titleInput.value}](${urlInput.value})`\r\n                }\r\n\r\n                return `![${titleInput.value}](${urlInput.value})`\r\n            }\r\n\r\n            const onKeydown = (e) => {\r\n                if (e.key === 'Escape') {\r\n                    e.preventDefault()\r\n                    closePopup()\r\n                    return\r\n                }\r\n\r\n                if (e.key !== 'Enter') {\r\n                    return\r\n                }\r\n\r\n                e.preventDefault()\r\n\r\n                const markup = getMarkup(styleName)\r\n                this.document.insert(this.elms.editor.cursorPos, markup)\r\n\r\n                this.elms.editor.focus()\r\n                this.elms.editor.setCursorPos(\r\n                    this.elms.editor.cursorPos + markup.length\r\n                )\r\n\r\n                closePopup(onKeydown)\r\n            }\r\n\r\n            const onDocumentClick = (e) => {\r\n                document.removeEventListener('click', onDocumentClick)\r\n\r\n                if (\r\n                    [button, [...button.querySelectorAll('*')]]\r\n                        .flat(Infinity)\r\n                        .indexOf(e.target) >= 0\r\n                )\r\n                    return\r\n\r\n                closePopup(onKeydown)\r\n            }\r\n\r\n            document.addEventListener('click', onDocumentClick)\r\n\r\n            button.classList.toggle('active')\r\n\r\n            if (!button.classList.contains('active')) {\r\n                urlInput.value = ''\r\n                titleInput.value = ''\r\n                return\r\n            }\r\n\r\n            urlInput.focus()\r\n\r\n            urlInput.addEventListener('keydown', onKeydown)\r\n            titleInput.addEventListener('keydown', onKeydown)\r\n        }\r\n\r\n        this.elms.popupButtons['link'].addEventListener('click', (e) =>\r\n            onPopupButtonClick('link', e)\r\n        )\r\n        this.elms.popupButtons['image'].addEventListener('click', (e) =>\r\n            onPopupButtonClick('image', e)\r\n        )\r\n\r\n        const onButtonClick = (styleName, e) => {\r\n            e.preventDefault()\r\n            this.elms.editor.focus()\r\n\r\n            const range = this.elms.editor.getSelection()\r\n            this.elms.editor.setCursorPos(\r\n                this.document.mark(styleName, [\r\n                    range.startOffset,\r\n                    range.endOffset,\r\n                ])\r\n            )\r\n        }\r\n\r\n        for (let styleName in this.document.styles) {\r\n            if (!(styleName in this.elms.buttons)) continue\r\n            this.elms.buttons[styleName].addEventListener('click', (e) =>\r\n                onButtonClick(styleName, e)\r\n            )\r\n        }\r\n    }\r\n\r\n    logger(historyEvent) {\r\n        if (!this.debug) return\r\n        console.log(\r\n            '\\n%cFired event %s\\n%c%s\\n%s\\n%c%s\\n%s%o\\n%s%o\\n',\r\n            ['font-weight: bold', 'margin-bottom: 6px'].join(';'),\r\n            historyEvent.type.toUpperCase(),\r\n            ['color: rgba(0,0,0,1)', 'padding-bottom: 6px'].join(';'),\r\n            this.document.text.slice(0, this.elms.editor.cursorPos) +\r\n                '][' +\r\n                this.document.text.slice(\r\n                    this.elms.editor.cursorPos,\r\n                    this.document.text.length\r\n                ),\r\n            this.document.toHtml(),\r\n            ['color: rgba(0,0,0,.9)', 'line-height: 1.4em'].join(';'),\r\n            `Document length: ${this.document.text.length}; Cursor position: ${this.elms.editor.cursorPos}`,\r\n            'Event details:',\r\n            historyEvent,\r\n            'Styles:',\r\n            this.document.styles\r\n        )\r\n    }\r\n\r\n    setText(text) {\r\n        this.elms.editor.cursorPos = 0\r\n        this.document.setText(text)\r\n    }\r\n\r\n    onTextUpdate() {\r\n        this.updatePlaceholder()\r\n\r\n        // this.elms.editor.innerHTML = this.document.toHtml()\r\n        if (this.outputContainer)\r\n            this.outputContainer.value = this.document.getFinalHtml()\r\n        if (this.originalOutputContainer)\r\n            this.originalOutputContainer.value = this.document.text\r\n\r\n        // this.elms.editor.setCursorPos(this.elms.editor.cursorPos)\r\n\r\n        this.dispatchEvent(\r\n            new CustomEvent('change', {\r\n                detail: {\r\n                    original: this.document.text,\r\n                    html: this.document.getFinalHtml(),\r\n                },\r\n            })\r\n        )\r\n    }\r\n\r\n    updatePlaceholder() {\r\n        if (this.document.text.length) {\r\n            this.elms.placeholder.classList.add('invisible')\r\n        } else {\r\n            this.elms.placeholder.classList.remove('invisible')\r\n        }\r\n    }\r\n\r\n    initEditor() {\r\n        this.elms.editor.initIO(this.document)\r\n    }\r\n}\r\n\r\ncustomElements.define('baka-editor', BakaEditor)\r\n","// @flow\r\n\r\nimport Document from './document'\r\n\r\nexport default class MarkdownDocument extends Document {\r\n    set styles(value: any) {}\r\n    get styles() {\r\n        let ranges: {\r\n            [string]: [number, number][],\r\n        } = {\r\n            bold: [],\r\n            italic: [],\r\n            underline: [],\r\n            strike: [],\r\n            monospace: [],\r\n            header_first: [],\r\n            header_second: [],\r\n            code: [],\r\n            quote: [],\r\n            service: [],\r\n            link: [],\r\n            image: [],\r\n            image_title: [],\r\n            link_title: [],\r\n        }\r\n\r\n        let text = this.text\r\n\r\n        const process = (styleNames, regexp, trigger) => {\r\n            const n = trigger.length\r\n            text = text.replace(regexp, (fullMatch, match, index) => {\r\n                let start = index + n\r\n                let end = index + fullMatch.length - n\r\n                for (let styleName of styleNames) {\r\n                    ranges[styleName].push([start, end])\r\n                }\r\n                ranges.service.push([start - n, start])\r\n                ranges.service.push([end, end + n])\r\n                const escapedTrigger = Array(n + 1).join('Ɇ')\r\n                // console.log(trigger, n, escapedTrigger)\r\n                return escapedTrigger + match + escapedTrigger\r\n            })\r\n            // console.log(text)\r\n        }\r\n\r\n        const processOneLine = (styleNames, regexp, n) => {\r\n            text.replace(regexp, (fullMatch, match, index) => {\r\n                let start = index\r\n                let end = index + fullMatch.length\r\n                for (let styleName of styleNames) {\r\n                    ranges[styleName].push([start, end])\r\n                }\r\n                ranges.service.push([start, start + n])\r\n                return match\r\n            })\r\n        }\r\n\r\n        const processLinks = () => {\r\n            // text.replace(\r\n            //     /(?<!!)\\[([^\\n\\r\\[\\]\\\\]*?)\\]\\(([^\\n\\r]+?)\\)/gm,\r\n            //     (fullMatch, title, link, index) => {\r\n            //         ranges['service'].push([index, index + 1])\r\n            //         ranges['service'].push([\r\n            //             index + 1 + title.length,\r\n            //             index + 1 + title.length + 1,\r\n            //         ])\r\n            //         ranges['link_title'].push([\r\n            //             index + 1,\r\n            //             index + 1 + title.length,\r\n            //         ])\r\n            //\r\n            //         let linkStart = index + 1 + title.length + 2\r\n            //         let linkEnd = linkStart + link.length\r\n            //         ranges['service'].push([linkStart - 1, linkStart])\r\n            //         ranges['service'].push([linkEnd, linkEnd + 1])\r\n            //         ranges['link'].push([linkStart, linkEnd])\r\n            //     }\r\n            // )\r\n        }\r\n\r\n        const processImages = () => {\r\n            text.replace(\r\n                /\\!\\[([^\\n\\r\\]\\[\\\\]*?)\\]\\(([^\\n\\r]+?)\\)/gm,\r\n                (fullMatch, title, link, index) => {\r\n                    ranges['service'].push([index, index + 2])\r\n                    ranges['service'].push([\r\n                        index + 2 + title.length,\r\n                        index + 2 + title.length + 1,\r\n                    ])\r\n                    ranges['image_title'].push([\r\n                        index + 2,\r\n                        index + 2 + title.length,\r\n                    ])\r\n\r\n                    let linkStart = index + 2 + title.length + 2\r\n                    let linkEnd = linkStart + link.length\r\n                    ranges['service'].push([linkStart - 1, linkStart])\r\n                    ranges['service'].push([linkEnd, linkEnd + 1])\r\n                    ranges['image'].push([linkStart, linkEnd])\r\n                }\r\n            )\r\n        }\r\n\r\n        const replaced_occurrences = []\r\n        const escapeMarkup = (regexp: RegExp, n: number) => {\r\n            text = text.replace(regexp, (full: string, match: string) => {\r\n                return (\r\n                    full.slice(0, n) +\r\n                    match.replace(\r\n                        /[*`_#~]/gm,\r\n                        (unsafe: string, index: number) => {\r\n                            replaced_occurrences.push(unsafe, index)\r\n                            return 'Ɇ'\r\n                        }\r\n                    ) +\r\n                    full.slice(full.length - n, full.length)\r\n                )\r\n            })\r\n        }\r\n\r\n        escapeMarkup(/```\\n([^`]+?)\\n```/gm, 4)\r\n        escapeMarkup(\r\n            /(https?:\\/\\/[-a-zA-Z0-9@:%._\\+~#=]{1,256}\\.[a-zA-Z0-9()]{1,6}\\b[-a-zA-Z0-9()@:%_\\+.~#?&\\/\\/=]*)/gm,\r\n            0\r\n        )\r\n\r\n        escapeMarkup(/\\\\(\\*)/, 0)\r\n        // escapeMarkup(/(?<!`|\\\\)`([^`\\n\\r]+?)`/gm, 1)\r\n\r\n        processLinks()\r\n        processImages()\r\n\r\n        // process(\r\n        //     ['link'],\r\n        //     /(?<!\\]\\()(https?:\\/\\/[-a-zA-Z0-9@:%._\\+~#=]{1,256}\\.[a-zA-Z0-9()]{1,6}\\b[-a-zA-Z0-9()@:%_\\+.~#?&\\/\\/=]*)/gm,\r\n        //     0\r\n        // )\r\n        //\r\n\r\n        process(['bold', 'italic'], /(?!\\\\)\\*{3}([^\\*]+)\\*{3}/gm, '***')\r\n\r\n        process(['bold'], /(?!\\\\)\\*{2}(?!\\*)([^\\*]+)\\*{2}(?!\\*|\\\\)/gm, '**')\r\n        process(['italic'], /(?!\\\\)\\*(?!\\*)([^\\*]+)\\*/gm, '*')\r\n\r\n        //\r\n        // process(['underline'], /__(.+?)__/gm, 2)\r\n        // process(['strike'], /~~(.+?)~~/gm, 2)\r\n        //\r\n        // process(['quote'], /(?<!`|\\\\)``\\n([^`]+?)\\n``/gm, 3)\r\n        // process(['monospace'], /(?<!`|\\\\)`([^`\\n\\r]+?)`/gm, 1)\r\n        // process(['code'], /```\\n([^`]+?)\\n```/gm, 4)\r\n        //\r\n        // processOneLine(['header_first'], /(?<!#|[^\\n])# ([^\\r\\n]+)/gm, 2)\r\n        // processOneLine(['header_second'], /(?<![^\\n])## ([^\\r\\n#]+)/gm, 3)\r\n\r\n        return {\r\n            bold: {\r\n                openTag: '<b>',\r\n                closeTag: '</b>',\r\n                ranges: ranges.bold,\r\n            },\r\n            italic: {\r\n                openTag: '<i>',\r\n                closeTag: '</i>',\r\n                ranges: ranges.italic,\r\n            },\r\n            underline: {\r\n                openTag: '<u>',\r\n                closeTag: '</u>',\r\n                ranges: ranges.underline,\r\n            },\r\n            strike: {\r\n                openTag: '<s>',\r\n                closeTag: '</s>',\r\n                ranges: ranges.strike,\r\n            },\r\n            monospace: {\r\n                openTag: '<span class=\"monospace\">',\r\n                closeTag: '</span>',\r\n                ranges: ranges.monospace,\r\n            },\r\n            code: {\r\n                openTag: '<span class=\"code\">',\r\n                closeTag: '</span>',\r\n                ranges: ranges.code,\r\n                block: true,\r\n            },\r\n            header_first: {\r\n                openTag: '<h1>',\r\n                closeTag: '</h1>',\r\n                ranges: ranges.header_first,\r\n                block: true,\r\n            },\r\n            header_second: {\r\n                openTag: '<h2>',\r\n                closeTag: '</h2>',\r\n                ranges: ranges.header_second,\r\n                block: true,\r\n            },\r\n            quote: {\r\n                openTag: '<blockquote>',\r\n                closeTag: '</blockquote>',\r\n                ranges: ranges.quote,\r\n                priority: 10,\r\n                block: true,\r\n            },\r\n            link: {\r\n                openTag: '<baka-link class=\"link\">',\r\n                closeTag: '</baka-link>',\r\n                ranges: ranges.link,\r\n            },\r\n            link_title: {\r\n                openTag: '<span class=\"service_link_title\">',\r\n                closeTag: '</span>',\r\n                ranges: ranges.link_title,\r\n            },\r\n            image: {\r\n                openTag: '<baka-link class=\"image_link\">',\r\n                closeTag: '</baka-link>',\r\n                ranges: ranges.image,\r\n            },\r\n            image_title: {\r\n                openTag: '<span class=\"service_image_title\">',\r\n                closeTag: '</span>',\r\n                ranges: ranges.image_title,\r\n            },\r\n            service: {\r\n                openTag: '<span class=\"service\">',\r\n                closeTag: '</span>',\r\n                ranges: ranges.service,\r\n                priority: 150,\r\n            },\r\n        }\r\n    }\r\n\r\n    mark(styleName: string, range: [number, number]): number {\r\n        let before: string = '',\r\n            start: string = '',\r\n            end: string = ''\r\n        if (range[0] > 0 && this.text[range[0] - 1] !== '\\n') before = '\\n'\r\n        switch (styleName) {\r\n            case 'bold':\r\n                start = '**'\r\n                end = '**'\r\n                break\r\n            case 'italic':\r\n                start = '*'\r\n                end = '*'\r\n                break\r\n            case 'underline':\r\n                start = '__'\r\n                end = '__'\r\n                break\r\n            case 'strike':\r\n                start = '~~'\r\n                end = '~~'\r\n                break\r\n            case 'monospace':\r\n                start = '`'\r\n                end = '`'\r\n                break\r\n            case 'quote':\r\n                start = before + '``\\n'\r\n                end = '\\n``\\n'\r\n                break\r\n            case 'code':\r\n                start = before + '```\\n'\r\n                end = '\\n```\\n'\r\n                break\r\n            case 'header_first':\r\n                start = before + '# '\r\n                end = '\\n'\r\n                break\r\n            case 'header_second':\r\n                start = before + '## '\r\n                end = '\\n'\r\n                break\r\n        }\r\n\r\n        this.insert(range[0], start)\r\n        this.insert(range[1] + start.length, end)\r\n        return range[1] + start.length\r\n    }\r\n\r\n    getStylesAtOffset(offset: number) {\r\n        let styles: {\r\n            [string]: [number, number],\r\n        } = {}\r\n        for (let styleName in this.styles) {\r\n            for (let i = 0; i < this.styles[styleName].ranges.length; i++) {\r\n                let range = this.styles[styleName].ranges[i]\r\n                if (!(range[0] <= offset && range[1] >= offset)) continue\r\n                styles[styleName] = range\r\n            }\r\n        }\r\n        return styles\r\n    }\r\n\r\n    getStylesAtRange(start: number, end: number) {\r\n        let styles: string[] = []\r\n        for (let styleName in this.styles) {\r\n            for (let i = 0; i < this.styles[styleName].ranges.length; i++) {\r\n                let range: [number, number] = this.styles[styleName].ranges[i]\r\n                if (\r\n                    !(\r\n                        (\r\n                            (range[0] >= start && range[0] <= end) || // Начало в выделении\r\n                            (range[1] >= start && range[1] <= end) || // Конец в выделении\r\n                            (range[0] <= start && range[1] >= end)\r\n                        ) // Выделение между началом и концом\r\n                    )\r\n                )\r\n                    continue\r\n                styles.push(styleName)\r\n            }\r\n        }\r\n        return styles\r\n    }\r\n\r\n    getFinalHtml() {\r\n        let html = this.toHtml()\r\n\r\n        // html = html.replace(\r\n        //     /(?<!<span class=\"service\">\\]\\(<\\/span>)<baka-link class=\"link\">(.+)<\\/baka-link>/gm,\r\n        //     (fullMatch, link) => `<a href=\"${link}\" target=\"_blank\">${link}</a>`\r\n        // )\r\n\r\n        const link_titles = []\r\n        // this.text.replace(\r\n        //     /(?<!!)\\[([^\\n\\r\\]\\[]*?)\\]\\(([^\\n\\r\\(\\)]+?)\\)/gm,\r\n        //     (full, title, link) => {\r\n        //         console.log(title, link)\r\n        //         link_titles.push(title ? title : link)\r\n        //     }\r\n        // )\r\n\r\n        let linkCounter = -1\r\n        html = html.replace(\r\n            /<baka-link class=\"link\">(.+?)<\\/baka-link>/gm,\r\n            (full, link) => {\r\n                console.log(full, link)\r\n                linkCounter++\r\n                return `<a href=\"${link}\" target=\"_blank\">${link_titles[linkCounter]}</a>`\r\n            }\r\n        )\r\n\r\n        const image_titles = []\r\n        this.text.replace(\r\n            /!\\[([^\\n\\r\\[\\]]*?)\\]\\(([^\\n\\r\\(\\)]+?)\\)/gm,\r\n            (full, title, link) => {\r\n                console.log(title, link)\r\n                image_titles.push(title ? title : '')\r\n            }\r\n        )\r\n\r\n        let imageCounter = -1\r\n        html = html.replace(\r\n            /<baka-link class=\"image_link\">(.+)<\\/baka-link>/gm,\r\n            (full, link) => {\r\n                console.log(full, link)\r\n                imageCounter++\r\n                return `<img src=\"${link}\" title=\"${image_titles[imageCounter]}\" />`\r\n            }\r\n        )\r\n\r\n        html = html.replace(/\\\\\\*/gm, '*')\r\n        html = html.replace(/\\\\`/gm, '`')\r\n        html = html.replace(/\\\\_/gm, '_')\r\n        html = html.replace(/\\\\#/gm, '#')\r\n        html = html.replace(/\\\\~/gm, '~')\r\n\r\n        html = html.replace(/\\n/gm, '<br/>').replace(/\\r/gm, '')\r\n\r\n        html = html.replace(\r\n            /<span class=[\"']service[_]*.*?[\"']>(.+?)<\\/span>/gm,\r\n            ''\r\n        )\r\n\r\n        Object.keys(this.styles).forEach((styleName) => {\r\n            const style = this.styles[styleName]\r\n            if (!style.block) return\r\n            html = html.replace(\r\n                new RegExp(\r\n                    `${style.openTag}(.+)${style.closeTag.replace(\r\n                        '/',\r\n                        '\\\\/'\r\n                    )}<br\\\\/>`\r\n                ),\r\n                `${style.openTag}$1${style.closeTag}`\r\n            )\r\n        })\r\n\r\n        return html\r\n    }\r\n}\r\n","// @flow\r\n\r\nexport function escapeHtml(unsafe: string): string {\r\n    return unsafe\r\n        .replace(/&/g, '&amp;')\r\n        .replace(/</g, '&lt;')\r\n        .replace(/>/g, '&gt;')\r\n        .replace(/\"/g, '&quot;')\r\n        .replace(/'/g, '&#039;')\r\n}\r\n"],"sourceRoot":""}