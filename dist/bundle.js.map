{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///./src/document.js","webpack:///./src/editable.js","webpack:///./src/index.js","webpack:///./src/markdown_document.js"],"names":["Document","start","n","text","offset","styles","styleName","i","ranges","length","range","end","push","historyItem","type","history","fireUpdate","value","beforeInsert","arr","Array","from","splice","join","insert","dir","beforeDelete","event","callback","listeners","callbacks","forEach","allRanges","lines","nodes","result","style","getStylesAtOffset","filter","rangeData","map","stylesEqual","a","b","el","indexOf","currentNode","currentLine","ch","node","openTag","closeTag","endsWith","Editable","setAttribute","addEventListener","focus","io","lastSelection","innerHTML","toHtml","insertText","console","log","collapsed","cursorPos","startOffset","setCursorPos","replace","endOffset","e","preventDefault","clipboardData","window","pastedData","getData","getSelection","inputType","data","ctrlKey","key","slice","firstIndex","regexp","match","matches","matchAll","index","navigationKeys","getCursorPos","getRangeAt","startContainer","parentElement","classList","contains","cb","__cursorPosListeners","container","childNodes","nodeName","flat","Infinity","lastNode","undefined","x","firstChild","line","document","activeElement","containerData","getContainerAtOffset","err","setEnd","setStart","caretOffset","selected","toString","preCaretRange","cloneRange","selectNodeContents","endContainer","brCount","cloneContents","querySelectorAll","firstOffset","getContainerOffset","secondOffset","__cursorPos","val","setTimeout","HTMLElement","customElements","define","BakaEditor","name","oldValue","newValue","elms","placeholder","outputContainer","querySelector","getAttribute","originalOutputContainer","template","wrapper","editor","onTextUpdate","bind","logger","initEditor","initButtons","Object","keys","getStylesAtRange","stylesOverride","remove","buttons","add","addCursorPosListener","updateButtons","bold","italic","strike","underline","monospace","onButtonClick","buttonName","unmark","mark","button","isActive","historyEvent","debug","toUpperCase","setText","getFinalHtml","dispatchEvent","CustomEvent","detail","original","html","initIO","MarkdownDocument","code","service","process","styleNames","fullMatch"],"mappings":"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","file":"bundle.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = \"./src/index.js\");\n","// @flow\r\n\r\ntype InsertEvent = {\r\n    type: 'insert',\r\n    start: number,\r\n    value: string,\r\n}\r\n\r\ntype DeleteEvent = {\r\n    type: 'delete',\r\n    start: number,\r\n    n: number,\r\n    dir: 'back' | 'forward',\r\n}\r\n\r\ntype SetTextEvent = {\r\n    type: 'set text',\r\n    text: string,\r\n}\r\n\r\nexport default class Document {\r\n    //    text = 'aabb\\nbbaa\\n'\r\n    text = ''\r\n    history: Array<InsertEvent | DeleteEvent | SetTextEvent> = []\r\n\r\n    beforeDelete(start: number, n: number) {}\r\n    beforeInsert(start: number, text: string) {}\r\n\r\n    getStylesAtOffset(offset: number) {\r\n        let styles = {}\r\n        for (let styleName in this.styles) {\r\n            for (let i = 0; i < this.styles[styleName].ranges.length; i++) {\r\n                let range = this.styles[styleName].ranges[i]\r\n                if (!(range[0] < offset && range[1] >= offset)) continue\r\n                styles[styleName] = range\r\n            }\r\n        }\r\n        return styles\r\n    }\r\n\r\n    getStylesAtRange(start: number, end: number) {\r\n        let styles = []\r\n        for (let styleName in this.styles) {\r\n            for (let i = 0; i < this.styles[styleName].ranges.length; i++) {\r\n                let range = this.styles[styleName].ranges[i]\r\n                if (\r\n                    !(\r\n                        (\r\n                            (range[0] >= start && range[0] < end) || // Начало в выделении\r\n                            (range[1] > start && range[1] <= end) || // Конец в выделении\r\n                            (range[0] <= start && range[1] >= end)\r\n                        ) // Выделение между началом и концом\r\n                    )\r\n                )\r\n                    continue\r\n                styles.push(styleName)\r\n            }\r\n        }\r\n        return styles\r\n    }\r\n\r\n    setText(text) {\r\n        const historyItem: SetTextEvent = { type: 'set text', text }\r\n        this.history = [historyItem]\r\n        this.text = text\r\n        this.fireUpdate(historyItem)\r\n    }\r\n\r\n    insert(start: number, value: string): void {\r\n        const historyItem: InsertEvent = { type: 'insert', value, start }\r\n        this.history.push(historyItem)\r\n\r\n        this.beforeInsert(start, value)\r\n\r\n        let arr = Array.from(this.text)\r\n        arr.splice(start, 0, value)\r\n        this.text = arr.join('')\r\n\r\n        this.fireUpdate(historyItem)\r\n    }\r\n\r\n    replace(start: number, end: number, value: string): void {\r\n        this.delete(start, end - start)\r\n        if (value) this.insert(start, value)\r\n    }\r\n\r\n    delete(start: number, n: number, dir: 'back' | 'forward' = 'back') {\r\n        const historyItem: DeleteEvent = { type: 'delete', n, start, dir }\r\n        this.history.push(historyItem)\r\n\r\n        this.beforeDelete(start, n)\r\n\r\n        let arr = Array.from(this.text)\r\n        arr.splice(start, n)\r\n        this.text = arr.join('')\r\n\r\n        this.fireUpdate(historyItem)\r\n    }\r\n\r\n    listeners: { [string]: Array<(event: mixed) => void> } = {}\r\n\r\n    addEventListener(event: string, callback: (event: mixed) => void): void {\r\n        if (this.listeners[event]) {\r\n            this.listeners[event].push(callback)\r\n        } else {\r\n            this.listeners[event] = [callback]\r\n        }\r\n    }\r\n\r\n    fireUpdate(event: mixed): void {\r\n        const callbacks = this.listeners['update']\r\n        if (!callbacks) return\r\n        callbacks.forEach((callback) => callback(event))\r\n    }\r\n\r\n    toHtml(): string {\r\n        if (!this.text.length) return '<div class=\"empty\">&#8203;</div>'\r\n        let allRanges: Array<{ style: string, range: [number, number] }> = []\r\n        let lines = [[]]\r\n        let nodes = []\r\n        let result = ''\r\n\r\n        for (let styleName in this.styles) {\r\n            for (let range of this.styles[styleName].ranges) {\r\n                allRanges.push({ style: styleName, range })\r\n            }\r\n        }\r\n\r\n        const getStylesAtOffset = (offset: number): string[] => {\r\n            return allRanges\r\n                .filter((rangeData) => {\r\n                    let range = rangeData.range\r\n                    return range[0] <= offset && range[1] > offset\r\n                })\r\n                .map((rangeData) => rangeData.style)\r\n        }\r\n\r\n        const stylesEqual = (a: string[], b: string[]) => {\r\n            if (a.length !== b.length) return false\r\n            return !a.filter((el) => b.indexOf(el) < 0).length\r\n        }\r\n\r\n        let currentNode: {\r\n            styles: string[],\r\n            text: string,\r\n            start: number,\r\n            end: number,\r\n        } = {\r\n            styles: getStylesAtOffset(0),\r\n            text: this.text[0],\r\n            start: 0,\r\n            end: 1,\r\n        }\r\n        let currentLine = 0\r\n        for (let i = 1; i < this.text.length; i++) {\r\n            let ch = this.text[i]\r\n            let styles = getStylesAtOffset(i)\r\n\r\n            if (\r\n                stylesEqual(currentNode.styles, styles) &&\r\n                (ch !== '\\n' || currentNode.styles.indexOf('code') >= 0)\r\n            ) {\r\n                currentNode.end = i\r\n                currentNode.text += ch === '\\n' ? '<br/>' : ch\r\n                continue\r\n            }\r\n\r\n            lines[currentLine].push(currentNode)\r\n            nodes.push(currentNode)\r\n            if (ch === '\\n') {\r\n                currentLine++\r\n                lines.push([])\r\n                // continue\r\n            }\r\n            currentNode = {\r\n                styles,\r\n                text: ch,\r\n                start: i,\r\n                end: i + 1,\r\n            }\r\n        }\r\n        lines[currentLine].push(currentNode)\r\n        nodes.push(currentNode)\r\n\r\n        for (let node of nodes) {\r\n            let start = node.styles\r\n                .map((styleName) => this.styles[styleName].openTag)\r\n                .join('')\r\n            let end = node.styles\r\n                .map((styleName) => this.styles[styleName].closeTag)\r\n                .join('')\r\n            result += start + node.text + end\r\n            // if (node.text !== '\\n') lineLength += node.text.length\r\n        }\r\n\r\n        if (result.endsWith('\\n')) result += '&#8203;'\r\n\r\n        return result\r\n    }\r\n}\r\n","// @flow\r\n\r\ntype CustomSelection = {\r\n    startOffset: number,\r\n    endOffset: number,\r\n\r\n    startContainer: Node,\r\n    endContainer: Node,\r\n\r\n    toString: () => string,\r\n    collapsed: boolean,\r\n}\r\n\r\ninterface IO {\r\n    delete(start: number, n: number, direction?: string): void;\r\n    insert(start: number, text: string): void;\r\n    replace(start: number, end: number, text: string): void;\r\n    toHtml(): string;\r\n\r\n    text: string;\r\n}\r\n\r\nclass Editable extends HTMLElement {\r\n    connectedCallback(): void {\r\n        this.setAttribute('contenteditable', 'true')\r\n        this.addEventListener('click', () => this.focus())\r\n    }\r\n\r\n    initIO(io: IO): void {\r\n        let lastSelection: CustomSelection\r\n\r\n        this.innerHTML = io.toHtml()\r\n\r\n        const insertText = (text: string, range: CustomSelection): void => {\r\n            console.log(range)\r\n            if (range.collapsed) {\r\n                this.cursorPos = range.startOffset+text.length\r\n                io.insert(range.startOffset, text)\r\n            } else {\r\n                this.setCursorPos(range.startOffset + text.length + text.length)\r\n                io.replace(range.startOffset + text.length, range.endOffset, text)\r\n            }\r\n        }\r\n\r\n        this.addEventListener('paste', (e: ClipboardEvent): void => {\r\n            e.preventDefault()\r\n            const clipboardData = e.clipboardData || window.clipboardData\r\n            const pastedData = clipboardData.getData('Text')\r\n            let range =\r\n                lastSelection && !lastSelection.collapsed\r\n                    ? lastSelection\r\n                    : this.getSelection()\r\n            insertText(pastedData, range)\r\n        })\r\n\r\n        this.addEventListener('input', (e: any): void => {\r\n            if (e.inputType !== 'insertText') return\r\n\r\n            e.preventDefault()\r\n\r\n            let range =\r\n                lastSelection && !lastSelection.collapsed\r\n                    ? lastSelection\r\n                    : this.getSelection()\r\n            range.startOffset -= e.data.length\r\n\r\n            insertText(e.data, range)\r\n        })\r\n\r\n        this.addEventListener('beforeinput', (e: any): void => {\r\n            if (e.inputType !== 'insertParagraph') return\r\n\r\n            e.preventDefault()\r\n\r\n            let range = this.getSelection()\r\n\r\n            console.log(range.startOffset)\r\n\r\n            if (range.collapsed) {\r\n                this.cursorPos = range.startOffset+1\r\n                this.setCursorPos(range.startOffset+1)\r\n                io.insert(range.startOffset, '\\n')\r\n                return\r\n            }\r\n\r\n            this.cursorPos = range.startOffset+1\r\n            io.replace(range.startOffset, range.endOffset, '\\n')\r\n        })\r\n\r\n        this.addEventListener('beforeinput', (e: any): void => {\r\n            if (e.inputType !== 'deleteContentBackward') return\r\n\r\n            e.preventDefault()\r\n\r\n            let range: CustomSelection = this.getSelection()\r\n            if (range.startOffset < 1 && range.collapsed) return\r\n\r\n            if (range.collapsed) {\r\n                this.cursorPos = range.startOffset - 1\r\n                io.delete(range.startOffset - 1, 1)\r\n                return\r\n            }\r\n            this.cursorPos = range.startOffset\r\n\r\n            io.delete(range.startOffset, range.endOffset - range.startOffset)\r\n        })\r\n\r\n        this.addEventListener('beforeinput', (e: any): void => {\r\n            if (e.inputType !== 'deleteContentForward') return\r\n\r\n            e.preventDefault()\r\n\r\n            let range = this.getSelection()\r\n            this.cursorPos = range.startOffset\r\n\r\n            if (range.collapsed) {\r\n                io.delete(range.startOffset, 1, 'forward')\r\n                return\r\n            }\r\n            io.replace(range.startOffset, range.endOffset, '')\r\n        })\r\n\r\n        this.addEventListener('keydown', (e: any): void => {\r\n            if (!e.ctrlKey || e.key !== 'Delete') return\r\n\r\n            e.preventDefault()\r\n\r\n            let text = io.text\r\n            let range = this.getSelection()\r\n\r\n            text = text.slice(range.startOffset, text.length)\r\n            let ch = io.text[range.startOffset]\r\n\r\n            let firstIndex\r\n            let regexp = ch.match(/\\s/) !== null ? /\\S/gm : /\\s/gm\r\n\r\n            let matches = Array.from(text.matchAll(regexp))\r\n\r\n            if (matches.length) firstIndex = matches[0].index\r\n            else firstIndex = text.length\r\n\r\n            io.delete(range.startOffset, firstIndex)\r\n            this.setCursorPos(range.startOffset)\r\n        })\r\n\r\n        this.addEventListener('keydown', (e: any): void => {\r\n            if (!e.ctrlKey || e.key !== 'Backspace') return\r\n\r\n            e.preventDefault()\r\n\r\n            let text = io.text\r\n            let range = this.getSelection()\r\n\r\n            text = text.slice(0, range.startOffset)\r\n            let ch = io.text[range.startOffset - 1]\r\n\r\n            let firstIndex\r\n            let regexp = ch.match(/\\s/) !== null ? /\\S/gm : /\\s/gm\r\n\r\n            let matches = Array.from(text.matchAll(regexp))\r\n\r\n            if (matches.length)\r\n                firstIndex = matches[matches.length - 1].index + 1\r\n            else firstIndex = 0\r\n\r\n            this.setCursorPos(range.startOffset - text.length + firstIndex)\r\n            io.delete(\r\n                range.startOffset - text.length + firstIndex,\r\n                text.length - firstIndex\r\n            )\r\n        })\r\n\r\n        this.addEventListener('keyup', (e: any): void => {\r\n            let navigationKeys = [\r\n                'ArrowLeft',\r\n                'ArrowRight',\r\n                'ArrowUp',\r\n                'ArrowDown',\r\n                'Home',\r\n                'End',\r\n                'PageUp',\r\n                'PageDown',\r\n            ]\r\n            if (navigationKeys.indexOf(e.key) < 0) return\r\n\r\n            this.cursorPos = this.getCursorPos()\r\n        })\r\n\r\n        this.addEventListener('mouseup', (): void => {\r\n            var range = window.getSelection().getRangeAt(0)\r\n            if (\r\n                range.startContainer.parentElement.classList.contains('empty')\r\n            ) {\r\n                this.setCursorPos(0)\r\n            }\r\n            this.cursorPos = this.getCursorPos()\r\n        })\r\n    }\r\n\r\n    __cursorPos = 0\r\n    __cursorPosListeners = []\r\n    get cursorPos() {\r\n        return this.__cursorPos\r\n    }\r\n    set cursorPos(val: number): void {\r\n        this.__cursorPos = val\r\n        this.__cursorPosListeners.forEach((cb) => setTimeout(() => cb(val), 1))\r\n    }\r\n\r\n    addCursorPosListener(cb: (event: mixed) => void): void {\r\n        this.__cursorPosListeners.push(cb)\r\n    }\r\n\r\n    getContainerOffset(container: HTMLElement): number {\r\n        let nodes: Array<any> = Array.from(this.childNodes)\r\n        while (nodes.filter((node) => node.childNodes.length).length) {\r\n            nodes = nodes\r\n                .map((el: Node) =>\r\n                    el.nodeName === '#text' || el.nodeName === 'BR'\r\n                        ? [el]\r\n                        : Array.from(el.childNodes)\r\n                )\r\n                .flat(Infinity)\r\n        }\r\n\r\n        let offset = 0\r\n        for (let node of nodes) {\r\n            if (node === container) break\r\n            offset += node.length || 1\r\n        }\r\n\r\n        return offset\r\n    }\r\n\r\n    getContainerAtOffset(offset: number): { line: Node, n: number } {\r\n        let nodes: Array<any> = Array.from(this.childNodes)\r\n        while (nodes.filter((node) => node.childNodes.length).length) {\r\n            nodes = nodes\r\n                .map((el: Node) =>\r\n                    el.nodeName === '#text' || el.nodeName === 'BR'\r\n                        ? [el]\r\n                        : Array.from(el.childNodes)\r\n                )\r\n                .flat(Infinity)\r\n        }\r\n\r\n        let lastNode: Node | void = undefined\r\n        let x = 0\r\n        for (let node of nodes) {\r\n            if (node.nodeName == 'BR') {\r\n                x += 1\r\n                continue\r\n            }\r\n            if (node.nodeName !== '#text') {\r\n                if (!node.firstChild) continue\r\n                node = node.firstChild\r\n            }\r\n            lastNode = node\r\n            if (x + (node.length || 1) >= offset) break\r\n            x += node.length || 1\r\n        }\r\n        return { line: lastNode || nodes[0], n: x }\r\n    }\r\n\r\n    setCursorPos(offset: number): void {\r\n        if (document.activeElement !== this) return\r\n        let containerData = this.getContainerAtOffset(offset)\r\n        let node = containerData.line\r\n        let n = containerData.n\r\n\r\n        if (!node) return\r\n\r\n        if (node.firstChild) node = node.firstChild\r\n\r\n        try {\r\n            var range = window.getSelection().getRangeAt(0)\r\n        } catch (err) {\r\n            return\r\n        }\r\n        range.setEnd(node, offset - n)\r\n        range.setStart(node, offset - n)\r\n        this.cursorPos = offset\r\n    }\r\n\r\n    getCursorPos(): number {\r\n        var caretOffset = 0\r\n        try {\r\n            var range = window.getSelection().getRangeAt(0)\r\n        } catch (err) {\r\n            return 0\r\n        }\r\n        var selected = range.toString().length\r\n        var preCaretRange = range.cloneRange()\r\n\r\n        preCaretRange.selectNodeContents(this)\r\n        preCaretRange.setEnd(range.endContainer, range.endOffset)\r\n        caretOffset = preCaretRange.toString().length - selected\r\n\r\n        const brCount = Array.from(preCaretRange.cloneContents().childNodes)\r\n            .map((el: HTMLElement) =>\r\n                el.nodeName === '#text'\r\n                    ? []\r\n                    : Array.from(el.querySelectorAll('*'))\r\n            )\r\n            .flat(Infinity)\r\n            .filter((el: any) => el.nodeName === 'BR').length\r\n        caretOffset += brCount\r\n\r\n        return caretOffset\r\n    }\r\n\r\n    getSelection(): CustomSelection {\r\n        let range\r\n        try {\r\n            range = window.getSelection().getRangeAt(0)\r\n            // console.log('Original range:', range)\r\n            // return range\r\n        } catch (err) {\r\n            return {\r\n                startOffset: 0,\r\n                endOffset: 0,\r\n                startContainer: this,\r\n                endContainer: this,\r\n                collapsed: true,\r\n                toString: () => '',\r\n            }\r\n        }\r\n        let result: CustomSelection = {}\r\n        let firstOffset = this.getContainerOffset(range.startContainer)\r\n        let secondOffset = this.getContainerOffset(range.endContainer)\r\n\r\n        // console.log('Offsets:', firstOffset, secondOffset)\r\n\r\n        result.toString = () => range.toString()\r\n\r\n        result.collapsed = range.collapsed\r\n\r\n        result.startContainer = range.startContainer\r\n        result.startOffset = range.startOffset + firstOffset\r\n\r\n        result.endContainer = range.endContainer\r\n        result.endOffset = range.endOffset + secondOffset\r\n\r\n        return result\r\n    }\r\n}\r\n\r\ncustomElements.define('baka-editable', Editable)\r\n","// @flow\r\n\r\nimport Document from './markdown_document'\r\nimport Editable from './editable'\r\n\r\nclass BakaEditor extends HTMLElement {\r\n    template = `<div id=\"wrapper\">\r\n        <div id=\"buttons\">\r\n            <a href=\"#\" id=\"bold\" tabindex=\"-1\" class=\"\">B</a>\r\n            <a href=\"#\" id=\"italic\" tabindex=\"-1\" class=\"\">I</a>\r\n            <a href=\"#\" id=\"strike\" tabindex=\"-1\" class=\"\">S</a>\r\n            <a href=\"#\" id=\"underline\" tabindex=\"-1\" class=\"\">U</a>\r\n            <a href=\"#\" id=\"monospace\" tabindex=\"-1\" class=\"\">M</a>\r\n        </div>\r\n        <div id=\"placeholder\">Type: Echo!</div>\r\n        <baka-editable id=\"editor\" />\r\n    </div>`\r\n\r\n    debug = true\r\n\r\n    elms: {\r\n        placeholder: HTMLElement,\r\n    } = {}\r\n    stylesOverride = {}\r\n    outputContainer: HTMLElement | void | null\r\n    originalOutputContainer: HTMLElement | void | null\r\n\r\n    static get observedAttributes() {\r\n        return ['placeholder', 'output', 'originaloutput']\r\n    }\r\n\r\n    attributeChangedCallback(name, oldValue, newValue) {\r\n        switch (name) {\r\n            case 'placeholder':\r\n                if (!this.elms.placeholder) break\r\n                this.elms.placeholder.innerHTML = newValue\r\n                break\r\n            case 'output':\r\n                this.outputContainer = document.querySelector(\r\n                    this.getAttribute('output')\r\n                )\r\n                break\r\n            case 'originaloutput':\r\n                this.originalOutputContainer = document.querySelector(\r\n                    this.getAttribute('originaloutput')\r\n                )\r\n                break\r\n        }\r\n    }\r\n\r\n    connectedCallback() {\r\n        this.innerHTML = this.template\r\n\r\n        this.outputContainer = document.querySelector(\r\n            this.getAttribute('output')\r\n        )\r\n\r\n        this.elms.wrapper = this.querySelector('#wrapper')\r\n        this.elms.editor = this.querySelector('#editor')\r\n\r\n        this.elms.placeholder = this.querySelector('#placeholder')\r\n        if (this.getAttribute('placeholder'))\r\n            this.elms.placeholder.innerHTML = this.getAttribute('placeholder')\r\n\r\n        this.document = new Document()\r\n        this.document.addEventListener('update', this.onTextUpdate.bind(this))\r\n        this.document.addEventListener('update', this.logger.bind(this))\r\n\r\n        this.initEditor()\r\n        this.initButtons()\r\n\r\n        this.logger({ type: 'INIT' })\r\n    }\r\n\r\n    updateButtons() {\r\n        let range = this.elms.editor.getSelection()\r\n        let offset = range.startOffset\r\n        const styles = range.collapsed\r\n            ? Object.keys(this.document.getStylesAtOffset(offset))\r\n            : this.document.getStylesAtRange(range.startOffset, range.endOffset)\r\n\r\n        for (let styleName in this.stylesOverride) {\r\n            if (\r\n                styles.indexOf(styleName) >= 0 &&\r\n                !this.stylesOverride[styleName]\r\n            ) {\r\n                styles.splice(styles.indexOf(styleName), 1)\r\n            }\r\n            if (\r\n                styles.indexOf(styleName) < 0 &&\r\n                this.stylesOverride[styleName]\r\n            ) {\r\n                styles.push(styleName)\r\n            }\r\n        }\r\n\r\n        this.elms.wrapper\r\n            .querySelectorAll('#buttons > a')\r\n            .forEach((el) => el.classList.remove('active'))\r\n        styles.forEach((style) => {\r\n            if (!(style in this.elms.buttons)) return\r\n            this.elms.buttons[style].classList.add('active')\r\n        })\r\n    }\r\n\r\n    initButtons() {\r\n        this.elms.editor.addCursorPosListener(() => {\r\n            this.stylesOverride = {}\r\n            this.updateButtons()\r\n        })\r\n        this.elms.buttons = {\r\n            wrapper: this.elms.wrapper.querySelector('#buttons'),\r\n            bold: this.elms.wrapper.querySelector('#buttons #bold'),\r\n            italic: this.elms.wrapper.querySelector('#buttons #italic'),\r\n            strike: this.elms.wrapper.querySelector('#buttons #strike'),\r\n            underline: this.elms.wrapper.querySelector('#buttons #underline'),\r\n            monospace: this.elms.wrapper.querySelector('#buttons #monospace'),\r\n        }\r\n\r\n        const onButtonClick = (buttonName, e) => {\r\n            e.preventDefault()\r\n            this.elms.editor.focus()\r\n\r\n            const range = this.elms.editor.getSelection()\r\n            if (!range.collapsed) {\r\n                const styles = this.document.getStylesAtRange(\r\n                    range.startOffset,\r\n                    range.endOffset\r\n                )\r\n                if (styles.indexOf(buttonName) >= 0) {\r\n                    this.document.unmark(\r\n                        buttonName,\r\n                        range.startOffset,\r\n                        range.endOffset\r\n                    )\r\n                } else {\r\n                    this.document.mark(\r\n                        buttonName,\r\n                        range.startOffset,\r\n                        range.endOffset\r\n                    )\r\n                }\r\n                this.elms.editor.cursorPos = range.endOffset\r\n                this.elms.editor.setCursorPos(range.endOffset)\r\n                return\r\n            }\r\n\r\n            const button = this.elms.buttons[buttonName]\r\n            const isActive = button.classList.contains('active')\r\n\r\n            this.stylesOverride[buttonName] = !isActive\r\n        }\r\n\r\n        for (let styleName in this.document.styles) {\r\n            if (!(styleName in this.elms.buttons)) continue\r\n            this.elms.buttons[styleName].addEventListener('click', (e) =>\r\n                onButtonClick(styleName, e)\r\n            )\r\n        }\r\n        window.document.addEventListener('click', () => {\r\n            this.updateButtons()\r\n        })\r\n    }\r\n\r\n    logger(historyEvent) {\r\n        if (!this.debug) return\r\n        console.log(\r\n            '\\n%cFired event %s\\n%c%s\\n%s\\n%c%s\\n%s%o\\n%s%o\\n',\r\n            ['font-weight: bold', 'margin-bottom: 6px'].join(';'),\r\n            historyEvent.type.toUpperCase(),\r\n            ['color: rgba(0,0,0,1)', 'padding-bottom: 6px'].join(';'),\r\n            this.document.text.slice(0, this.elms.editor.cursorPos) +\r\n                '][' +\r\n                this.document.text.slice(\r\n                    this.elms.editor.cursorPos,\r\n                    this.document.text.length\r\n                ),\r\n            this.document.toHtml(),\r\n            ['color: rgba(0,0,0,.9)', 'line-height: 1.4em'].join(';'),\r\n            `Document length: ${this.document.text.length}; Cursor position: ${this.elms.editor.cursorPos}`,\r\n            'Event details:',\r\n            historyEvent,\r\n            'Styles:',\r\n            this.document.styles\r\n        )\r\n    }\r\n\r\n    setText(text) {\r\n        this.elms.editor.cursorPos = 0\r\n        this.document.setText(text)\r\n    }\r\n\r\n    onTextUpdate() {\r\n        if (this.document.text.length) {\r\n            this.elms.placeholder.classList.add('invisible')\r\n        } else {\r\n            this.elms.placeholder.classList.remove('invisible')\r\n        }\r\n\r\n        this.elms.editor.innerHTML = this.document.toHtml()\r\n        if (this.outputContainer)\r\n            this.outputContainer.value = this.document.getFinalHtml()\r\n        if (this.originalOutputContainer)\r\n            this.originalOutputContainer.value = this.document.text\r\n        this.elms.editor.setCursorPos(this.elms.editor.cursorPos)\r\n        this.dispatchEvent(\r\n            new CustomEvent('change', {\r\n                detail: {\r\n                    original: this.document.text,\r\n                    html: this.document.getFinalHtml(),\r\n                },\r\n            })\r\n        )\r\n    }\r\n\r\n    initEditor() {\r\n        if (this.document.text.length) {\r\n            this.elms.placeholder.classList.add('invisible')\r\n        } else {\r\n            this.elms.placeholder.classList.remove('invisible')\r\n        }\r\n\r\n        this.elms.editor.initIO(this.document)\r\n    }\r\n}\r\n\r\ncustomElements.define('baka-editor', BakaEditor)\r\n","// @flow\r\n\r\nimport Document from './document'\r\n\r\nexport default class MarkdownDocument extends Document {\r\n    // text = '```Hello, world!\\nIts me, Dio!\\n```'\r\n    // text = '*Привет*, **мир**!\\n\\n***Сегодня*** __я__ ~~делаю~~ `маркдаун`!'\r\n\r\n    // text = 'as\\ndf'\r\n\r\n    set styles(value: any) {}\r\n    get styles() {\r\n        let ranges: {\r\n            [string]: [number, number][],\r\n        } = {\r\n            bold: [],\r\n            italic: [],\r\n            underline: [],\r\n            strike: [],\r\n            monospace: [],\r\n            code: [],\r\n            service: [],\r\n        }\r\n\r\n        const process = (styleNames, regexp, n) => {\r\n            this.text.replace(regexp, (fullMatch, match, index) => {\r\n                let start = index + n\r\n                let end = index + fullMatch.length - n\r\n                for (let styleName of styleNames) {\r\n                    ranges[styleName].push([start, end])\r\n                }\r\n                ranges.service.push([start - n, start])\r\n                ranges.service.push([end, end + n])\r\n                return match\r\n            })\r\n        }\r\n\r\n        process(\r\n            ['bold'],\r\n            /(?<!\\*|\\\\\\*)\\*{2,2}[^*\\n]([\\s\\S]+?)[^*]\\*{2,2}(?!\\*|\\\\)/gm,\r\n            2\r\n        )\r\n        process(['italic'], /((?<!\\*|\\\\)\\*[^*\\n][\\s\\S]+?[^*|\\\\]\\*(?!\\*))/gm, 1)\r\n        process(\r\n            ['bold', 'italic'],\r\n            /(?<!\\*|\\\\)\\*{3,3}[^*\\n]([\\s\\S]+?)[^*|\\\\]\\*{3,3}(?!\\*)/gm,\r\n            3\r\n        )\r\n        process(\r\n            ['code'],\r\n            /(?<!`|\\\\)`{3,3}[^`]([\\s\\S]+?)[^`|\\\\]`{3,3}(?!`)/gm,\r\n            3\r\n        )\r\n        process(['underline'], /__(.+?)__/gm, 2)\r\n        process(['strike'], /~~(.+?)~~/gm, 2)\r\n        process(['monospace'], /`([^`]*)`/, 1)\r\n\r\n        return {\r\n            bold: {\r\n                openTag: '<b>',\r\n                closeTag: '</b>',\r\n                ranges: ranges.bold,\r\n            },\r\n            italic: {\r\n                openTag: '<i>',\r\n                closeTag: '</i>',\r\n                ranges: ranges.italic,\r\n            },\r\n            underline: {\r\n                openTag: '<u>',\r\n                closeTag: '</u>',\r\n                ranges: ranges.underline,\r\n            },\r\n            strike: {\r\n                openTag: '<s>',\r\n                closeTag: '</s>',\r\n                ranges: ranges.strike,\r\n            },\r\n            monospace: {\r\n                openTag: '<span class=\"monospace\">',\r\n                closeTag: '</span>',\r\n                ranges: ranges.monospace,\r\n            },\r\n            code: {\r\n                openTag: '<span class=\"code\">',\r\n                closeTag: '</span>',\r\n                ranges: ranges.code,\r\n            },\r\n            service: {\r\n                openTag: '<span class=\"service\">',\r\n                closeTag: '</span>',\r\n                ranges: ranges.service,\r\n            },\r\n        }\r\n    }\r\n\r\n    getStylesAtOffset(offset: number) {\r\n        let styles: {\r\n            [string]: [number, number],\r\n        } = {}\r\n        for (let styleName in this.styles) {\r\n            for (let i = 0; i < this.styles[styleName].ranges.length; i++) {\r\n                let range = this.styles[styleName].ranges[i]\r\n                if (!(range[0] <= offset && range[1] >= offset)) continue\r\n                styles[styleName] = range\r\n            }\r\n        }\r\n        return styles\r\n    }\r\n\r\n    getStylesAtRange(start: number, end: number) {\r\n        let styles: string[] = []\r\n        for (let styleName in this.styles) {\r\n            for (let i = 0; i < this.styles[styleName].ranges.length; i++) {\r\n                let range: [number, number] = this.styles[styleName].ranges[i]\r\n                if (\r\n                    !(\r\n                        (\r\n                            (range[0] >= start && range[0] <= end) || // Начало в выделении\r\n                            (range[1] >= start && range[1] <= end) || // Конец в выделении\r\n                            (range[0] <= start && range[1] >= end)\r\n                        ) // Выделение между началом и концом\r\n                    )\r\n                )\r\n                    continue\r\n                styles.push(styleName)\r\n            }\r\n        }\r\n        return styles\r\n    }\r\n\r\n    getFinalHtml() {\r\n        let html = this.toHtml()\r\n        html = html.replace(/\\n/gm, '<br/>\\n')\r\n        return html.replace(/<span class=\"service\">(.+?)<\\/span>/gm, '')\r\n    }\r\n}\r\n"],"sourceRoot":""}