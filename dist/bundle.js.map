{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///./src/baka_link.js","webpack:///./src/document.js","webpack:///./src/editable.js","webpack:///./src/index.js","webpack:///./src/markdown_document.js"],"names":["BakaLink","observer","MutationObserver","mutations","querySelector","update","observe","childList","el","document","createElement","href","innerText","target","innerHTML","appendChild","HTMLElement","customElements","define","Document","historyOffset","history","length","item","console","log","type","start","value","insert","replace","from","fireUpdate","n","dir","end","text","offset","styles","styleName","i","ranges","range","push","historyItem","save","beforeInsert","arr","Array","splice","join","slice","to","beforeDelete","event","callback","listeners","callbacks","forEach","allRanges","lines","nodes","result","style","getStylesAtOffset","filter","rangeData","map","stylesEqual","a","b","indexOf","findDiff","first","second","currentNode","currentLine","ch","subtractArray","x","y","reversed","myArr","reverse","activeStyles","Set","node","diff","minIndex","reduce","accumulator","index","size","stylesToClose","stylesToOpen","add","openTag","prevEnd","closeTag","endsWith","Editable","setAttribute","addEventListener","focus","io","lastSelection","toHtml","revertedItem","setCursorPos","insertText","collapsed","cursorPos","startOffset","endOffset","e","preventDefault","clipboardData","window","pastedData","getData","getSelection","inputType","data","ctrlKey","key","firstIndex","regexp","match","matches","matchAll","navigationKeys","getCursorPos","shiftKey","undo","redo","getRangeAt","startContainer","parentElement","classList","contains","cb","__cursorPosListeners","container","childNodes","nodeName","flat","Infinity","lastNode","undefined","firstChild","line","activeElement","containerData","getContainerAtOffset","err","setEnd","setStart","caretOffset","selected","toString","preCaretRange","cloneRange","selectNodeContents","endContainer","brCount","cloneContents","querySelectorAll","firstOffset","getContainerOffset","secondOffset","__cursorPos","val","setTimeout","BakaEditor","name","oldValue","newValue","debug","getAttribute","elms","placeholder","outputContainer","originalOutputContainer","template","wrapper","editor","onTextUpdate","bind","logger","initEditor","initButtons","Object","keys","getStylesAtRange","stylesOverride","remove","buttons","addCursorPosListener","updateButtons","bold","italic","strike","underline","monospace","onButtonClick","buttonName","unmark","mark","button","isActive","historyEvent","toUpperCase","setText","getFinalHtml","dispatchEvent","CustomEvent","detail","original","html","initIO","MarkdownDocument","link_titles","full","title","link","image_titles","linkCounter","imageCounter","header_first","header_second","code","quote","service","image","image_title","link_title","process","styleNames","fullMatch","processOneLine","processGroup","prevIndex","findIndex","processLinks","linkStart","linkEnd","processImages"],"mappings":"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","file":"bundle.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = \"./src/index.js\");\n","// @flow\r\n\r\nexport default class BakaLink extends HTMLElement {\r\n    connectedCallback(): void {\r\n        const observer = new MutationObserver((mutations) => {\r\n            if (this.querySelector('a')) return\r\n            this.update()\r\n        })\r\n\r\n        observer.observe(this, { childList: true })\r\n\r\n        this.update()\r\n    }\r\n\r\n    update() {\r\n        const el = document.createElement('a')\r\n        el.href = this.innerText\r\n        el.target = '_blank'\r\n        el.innerText = this.innerText\r\n        this.innerHTML = ''\r\n        this.appendChild(el)\r\n    }\r\n}\r\n\r\ncustomElements.define('baka-link', BakaLink)\r\n","// @flow\n\ntype InsertEvent = {\n    type: 'insert',\n    start: number,\n    value: string,\n}\n\ntype DeleteEvent = {\n    type: 'delete',\n    start: number,\n    n: number,\n    value: string,\n    dir: 'back' | 'forward',\n}\n\ntype ReplaceEvent = {\n    type: 'replace',\n    start: number,\n    end: number,\n    from: string,\n    to: string,\n}\n\ntype SetTextEvent = {\n    type: 'set text',\n    text: string,\n}\n\ntype MyNode = {\n    styles: string[],\n    text: string,\n    start: number,\n    end: number,\n}\n\nexport interface IO {\n    text: string;\n\n    history: Array<InsertEvent | DeleteEvent | SetTextEvent | ReplaceEvent>;\n    addEventListener: (\n        event: string,\n        item: InsertEvent | DeleteEvent | SetTextEvent | ReplaceEvent\n    ) => {};\n\n    undo(): void;\n    redo(): void;\n\n    delete(start: number, n: number, direction?: string): void;\n    insert(start: number, text: string): void;\n    replace(start: number, end: number, text: string): void;\n\n    toHtml(): string;\n\n    text: string;\n}\n\nexport default class Document {\n    //    text = 'aabb\\nbbaa\\n'\n    text = ''\n    history: Array<InsertEvent | DeleteEvent | SetTextEvent | ReplaceEvent> = []\n    historyOffset: number = -1\n\n    undo() {\n        if (this.historyOffset === this.history.length - 1) return\n        this.historyOffset += 1\n        let item = this.history[this.history.length - this.historyOffset - 1]\n        console.log(this.history, this.historyOffset, item)\n        switch (item.type) {\n            case 'insert':\n                this.delete(item.start, item.value.length, 'back', false)\n                break\n            case 'delete':\n                this.insert(item.start, item.value, false)\n                break\n            case 'replace':\n                this.replace(\n                    item.start,\n                    item.start + item.from.length,\n                    item.from,\n                    false\n                )\n                break\n        }\n        this.fireUpdate(item, 'undo')\n    }\n\n    redo() {\n        if (this.historyOffset === 0) return\n        this.historyOffset -= 1\n        let item = this.history[this.history.length - this.historyOffset - 1]\n        console.log(this.history, this.historyOffset, item)\n        switch (item.type) {\n            case 'insert':\n                this.insert(item.start, item.value, false)\n                break\n            case 'delete':\n                this.delete(item.start, item.n, item.dir, false)\n                break\n            case 'replace':\n                this.replace(item.start, item.end, item.value)\n                break\n        }\n        this.fireUpdate(item, 'redo')\n    }\n\n    beforeDelete(start: number, n: number) {}\n    beforeInsert(start: number, text: string) {}\n\n    getStylesAtOffset(offset: number) {\n        let styles = {}\n        for (let styleName in this.styles) {\n            for (let i = 0; i < this.styles[styleName].ranges.length; i++) {\n                let range = this.styles[styleName].ranges[i]\n                if (!(range[0] < offset && range[1] >= offset)) continue\n                styles[styleName] = range\n            }\n        }\n        return styles\n    }\n\n    getStylesAtRange(start: number, end: number) {\n        let styles = []\n        for (let styleName in this.styles) {\n            for (let i = 0; i < this.styles[styleName].ranges.length; i++) {\n                let range = this.styles[styleName].ranges[i]\n                if (\n                    !(\n                        (\n                            (range[0] >= start && range[0] < end) || // Начало в выделении\n                            (range[1] > start && range[1] <= end) || // Конец в выделении\n                            (range[0] <= start && range[1] >= end)\n                        ) // Выделение между началом и концом\n                    )\n                )\n                    continue\n                styles.push(styleName)\n            }\n        }\n        return styles\n    }\n\n    setText(text) {\n        const historyItem: SetTextEvent = { type: 'set text', text }\n        this.history = [historyItem]\n        this.text = text\n        this.fireUpdate(historyItem)\n    }\n\n    insert(\n        start: number,\n        value: string,\n        save: boolean = true,\n        update: bolean = true\n    ): void {\n        const historyItem: InsertEvent = { type: 'insert', value, start }\n        if (save) {\n            this.history.push(historyItem)\n            this.historyOffset = -1\n        }\n\n        this.beforeInsert(start, value)\n\n        let arr = Array.from(this.text)\n        arr.splice(start, 0, value)\n        this.text = arr.join('')\n\n        if (update) this.fireUpdate(historyItem)\n    }\n\n    replace(\n        start: number,\n        end: number,\n        value: string,\n        save: boolean = true,\n        update: boolean = true\n    ): void {\n        const historyItem: ReplaceEvent = {\n            type: 'replace',\n            start,\n            end,\n            from: this.text.slice(start, end),\n            to: value,\n        }\n        if (save) {\n            this.history.push(historyItem)\n            this.historyOffset = -1\n        }\n        this.delete(start, end - start, 'back', false, false)\n        if (value) this.insert(start, value, false, false)\n        if (update) this.fireUpdate(historyItem)\n    }\n\n    delete(\n        start: number,\n        n: number,\n        dir: 'back' | 'forward' = 'back',\n        save: boolean = true,\n        update: boolean = true\n    ) {\n        const historyItem: DeleteEvent = {\n            type: 'delete',\n            n,\n            start,\n            dir,\n            value: this.text.slice(start, start + n),\n        }\n        if (save) {\n            this.history.push(historyItem)\n            this.historyOffset = -1\n        }\n\n        this.beforeDelete(start, n)\n\n        let arr = Array.from(this.text)\n        arr.splice(start, n)\n        this.text = arr.join('')\n\n        if (update) this.fireUpdate(historyItem)\n    }\n\n    listeners: { [string]: Array<(event: mixed) => void> } = {}\n\n    addEventListener(event: string, callback: (event: mixed) => void): void {\n        if (this.listeners[event]) {\n            this.listeners[event].push(callback)\n        } else {\n            this.listeners[event] = [callback]\n        }\n    }\n\n    fireUpdate(event: mixed, type: string = 'update'): void {\n        const callbacks = this.listeners[type]\n        if (!callbacks) return\n        callbacks.forEach((callback) => callback(event))\n    }\n\n    toHtml(): string {\n        if (!this.text.length) return '<div class=\"empty\">&#8203;</div>'\n        let allRanges: Array<{ style: string, range: [number, number] }> = []\n        let lines = [[]]\n        let nodes: Array<MyNode> = []\n        let result = ''\n\n        for (let styleName in this.styles) {\n            for (let range of this.styles[styleName].ranges) {\n                allRanges.push({ style: styleName, range })\n            }\n        }\n\n        const getStylesAtOffset = (offset: number): string[] => {\n            return allRanges\n                .filter((rangeData) => {\n                    let range = rangeData.range\n                    return range[0] <= offset && range[1] > offset\n                })\n                .map((rangeData) => rangeData.style)\n        }\n\n        const stylesEqual = (a: string[], b: string[]) => {\n            if (a.length !== b.length) return false\n            return !a.filter((el) => b.indexOf(el) < 0).length\n        }\n\n        const findDiff = (a: string[], b: string[]) => {\n            let [first, second] = a.length >= b.length ? [a, b] : [b, a]\n            return first.filter((el) => second.indexOf(el) < 0)\n        }\n\n        let currentNode: MyNode = {\n            styles: getStylesAtOffset(0),\n            text: this.text[0],\n            start: 0,\n            end: 1,\n        }\n        let currentLine = 0\n        for (let i = 1; i < this.text.length; i++) {\n            let ch = this.text[i]\n            let styles = getStylesAtOffset(i)\n\n            if (stylesEqual(currentNode.styles, styles)) {\n                currentNode.end = i\n                currentNode.text += ch === '\\n' ? '<br/>' : ch\n                continue\n            }\n\n            lines[currentLine].push(currentNode)\n            nodes.push(currentNode)\n            if (ch === '\\n') {\n                currentLine++\n                lines.push([])\n                // continue\n            }\n            currentNode = {\n                styles,\n                text: ch,\n                start: i,\n                end: i + 1,\n            }\n        }\n        lines[currentLine].push(currentNode)\n        nodes.push(currentNode)\n\n        const subtractArray = (x, y) => {\n            return x.filter((el) => y.indexOf(el) < 0)\n        }\n\n        const reversed = (arr) => {\n            let myArr = [...arr]\n            myArr.reverse()\n            return myArr\n        }\n\n        let activeStyles = new Set()\n        for (let node of nodes) {\n            const diff = subtractArray([...activeStyles], node.styles)\n            const minIndex = diff.reduce((accumulator, styleName) => {\n                const index = [...activeStyles].indexOf(styleName)\n                if (index < accumulator) return index\n            }, activeStyles.size)\n            const stylesToClose = reversed(\n                [...activeStyles].slice(minIndex, activeStyles.size)\n            )\n            stylesToClose.forEach((styleName) => activeStyles.delete(styleName))\n\n            const stylesToOpen = subtractArray(node.styles, [...activeStyles])\n            stylesToOpen.forEach((styleName) => activeStyles.add(styleName))\n\n            let start = stylesToOpen\n                .map((styleName) => this.styles[styleName].openTag)\n                .join('')\n            let prevEnd = stylesToClose\n                .map((styleName) => this.styles[styleName].closeTag)\n                .join('')\n            result += prevEnd + start + node.text\n        }\n\n        result += reversed([...activeStyles])\n            .map((styleName) => this.styles[styleName].closeTag)\n            .join('')\n\n        if (result.endsWith('\\n') || result.endsWith('<br/>'))\n            result += '&#8203;'\n\n        result = result\n            .replace(/<br\\/><\\//gm, '<br/>&#8203;<')\n            .replace(/<\\/h1><br\\/>/gm, '</h1>')\n            .replace(/<\\/h2><br\\/>/gm, '</h2>')\n            .replace(/\\r/gm, '')\n\n        return result\n    }\n}\n","// @flow\r\n\r\nimport type IO from './document'\r\n\r\ntype CustomSelection = {\r\n    startOffset: number,\r\n    endOffset: number,\r\n\r\n    startContainer: Node,\r\n    endContainer: Node,\r\n\r\n    toString: () => string,\r\n    collapsed: boolean,\r\n}\r\n\r\nclass Editable extends HTMLElement {\r\n    connectedCallback(): void {\r\n        this.setAttribute('contenteditable', 'true')\r\n        this.addEventListener('click', () => this.focus())\r\n    }\r\n\r\n    initIO(io: IO): void {\r\n        let lastSelection: CustomSelection\r\n\r\n        this.innerHTML = io.toHtml()\r\n\r\n        io.addEventListener('undo', (revertedItem) => {\r\n            if (revertedItem.type === 'insert') {\r\n                this.setCursorPos(revertedItem.start)\r\n            }\r\n\r\n            if (revertedItem.type === 'delete') {\r\n                this.setCursorPos(revertedItem.start + revertedItem.n)\r\n            }\r\n        })\r\n        io.addEventListener('redo', (revertedItem) => {\r\n            if (revertedItem.type === 'insert') {\r\n                this.setCursorPos(\r\n                    revertedItem.start + revertedItem.value.length\r\n                )\r\n            }\r\n\r\n            if (revertedItem.type === 'delete') {\r\n                this.setCursorPos(revertedItem.start)\r\n            }\r\n        })\r\n\r\n        const insertText = (text: string, range: CustomSelection): void => {\r\n            console.log(range)\r\n            if (range.collapsed) {\r\n                this.cursorPos = range.startOffset + text.length\r\n                io.insert(range.startOffset, text)\r\n            } else {\r\n                this.cursorPos = range.startOffset + text.length\r\n                // this.setCursorPos(range.startOffset + text.length)\r\n                io.replace(range.startOffset, range.endOffset, text)\r\n            }\r\n        }\r\n\r\n        this.addEventListener('paste', (e: ClipboardEvent): void => {\r\n            e.preventDefault()\r\n            const clipboardData = e.clipboardData || window.clipboardData\r\n            const pastedData = clipboardData.getData('Text').replace(/\\r/gm, '')\r\n            console.log(pastedData, pastedData.length)\r\n\r\n            let range =\r\n                lastSelection && !lastSelection.collapsed\r\n                    ? lastSelection\r\n                    : this.getSelection()\r\n            insertText(pastedData, range)\r\n            lastSelection = null\r\n        })\r\n\r\n        this.addEventListener('beforeinput', (e: any): void => {\r\n            if (e.inputType !== 'insertText') return\r\n\r\n            e.preventDefault()\r\n            console.log('Last vs new:')\r\n            console.log(lastSelection, this.getSelection())\r\n\r\n            let range =\r\n                lastSelection && !lastSelection.collapsed\r\n                    ? lastSelection\r\n                    : this.getSelection()\r\n\r\n            insertText(e.data, range)\r\n        })\r\n\r\n        this.addEventListener('beforeinput', (e: any): void => {\r\n            if (e.inputType !== 'insertParagraph') return\r\n\r\n            e.preventDefault()\r\n\r\n            let range = this.getSelection()\r\n\r\n            console.log(range.startOffset)\r\n\r\n            if (range.collapsed) {\r\n                this.cursorPos = range.startOffset + 1\r\n                this.setCursorPos(range.startOffset + 1)\r\n                io.insert(range.startOffset, '\\n')\r\n                return\r\n            }\r\n\r\n            this.cursorPos = range.startOffset + 1\r\n            io.replace(range.startOffset, range.endOffset, '\\n')\r\n        })\r\n\r\n        this.addEventListener('beforeinput', (e: any): void => {\r\n            if (e.inputType !== 'deleteContentBackward') return\r\n\r\n            e.preventDefault()\r\n\r\n            let range: CustomSelection = this.getSelection()\r\n            if (range.startOffset < 1 && range.collapsed) return\r\n\r\n            if (range.collapsed) {\r\n                this.cursorPos = range.startOffset - 1\r\n                io.delete(range.startOffset - 1, 1)\r\n                return\r\n            }\r\n            this.cursorPos = range.startOffset\r\n\r\n            io.delete(range.startOffset, range.endOffset - range.startOffset)\r\n        })\r\n\r\n        this.addEventListener('beforeinput', (e: any): void => {\r\n            if (e.inputType !== 'deleteContentForward') return\r\n\r\n            e.preventDefault()\r\n\r\n            let range = this.getSelection()\r\n            this.cursorPos = range.startOffset\r\n\r\n            if (range.collapsed) {\r\n                io.delete(range.startOffset, 1, 'forward')\r\n                return\r\n            }\r\n            io.replace(range.startOffset, range.endOffset, '')\r\n        })\r\n\r\n        this.addEventListener('keydown', (e: any): void => {\r\n            if (!e.ctrlKey || e.key !== 'Delete') return\r\n\r\n            e.preventDefault()\r\n\r\n            let text = io.text\r\n            let range = this.getSelection()\r\n\r\n            text = text.slice(range.startOffset, text.length)\r\n            let ch = io.text[range.startOffset]\r\n\r\n            let firstIndex\r\n            let regexp = ch.match(/\\s/) !== null ? /\\S/gm : /\\s/gm\r\n\r\n            let matches = Array.from(text.matchAll(regexp))\r\n\r\n            if (matches.length) firstIndex = matches[0].index\r\n            else firstIndex = text.length\r\n\r\n            io.delete(range.startOffset, firstIndex)\r\n            this.setCursorPos(range.startOffset)\r\n        })\r\n\r\n        this.addEventListener('keydown', (e: any): void => {\r\n            if (!e.ctrlKey || e.key !== 'Backspace') return\r\n\r\n            e.preventDefault()\r\n\r\n            let text = io.text\r\n            let range = this.getSelection()\r\n\r\n            text = text.slice(0, range.startOffset)\r\n            let ch = io.text[range.startOffset - 1]\r\n\r\n            let firstIndex\r\n            let regexp = ch.match(/\\s/) !== null ? /\\S/gm : /\\s/gm\r\n\r\n            let matches = Array.from(text.matchAll(regexp))\r\n\r\n            if (matches.length)\r\n                firstIndex = matches[matches.length - 1].index + 1\r\n            else firstIndex = 0\r\n\r\n            this.setCursorPos(range.startOffset - text.length + firstIndex)\r\n            io.delete(\r\n                range.startOffset - text.length + firstIndex,\r\n                text.length - firstIndex\r\n            )\r\n        })\r\n\r\n        this.addEventListener('keyup', (e: any): void => {\r\n            let navigationKeys = [\r\n                'ArrowLeft',\r\n                'ArrowRight',\r\n                'ArrowUp',\r\n                'ArrowDown',\r\n                'Home',\r\n                'End',\r\n                'PageUp',\r\n                'PageDown',\r\n            ]\r\n            if (navigationKeys.indexOf(e.key) < 0) return\r\n\r\n            this.cursorPos = this.getCursorPos()\r\n        })\r\n\r\n        this.addEventListener('keydown', (e: any): void => {\r\n            if (!e.ctrlKey || e.key !== 'z' || e.shiftKey) return\r\n\r\n            io.undo()\r\n        })\r\n\r\n        this.addEventListener('keydown', (e: any): void => {\r\n            if (!e.ctrlKey || e.key !== 'Z' || !e.shiftKey) return\r\n            console.log('redo')\r\n            io.redo()\r\n        })\r\n\r\n        this.addEventListener('keydown', (e: any): void => {\r\n            if (!e.ctrlKey || e.key !== 'v') return\r\n            lastSelection = this.getSelection()\r\n        })\r\n\r\n        this.addEventListener('mouseup', (): void => {\r\n            var range = window.getSelection().getRangeAt(0)\r\n            if (\r\n                range.startContainer.parentElement.classList.contains('empty')\r\n            ) {\r\n                this.setCursorPos(0)\r\n            }\r\n            this.cursorPos = this.getCursorPos()\r\n        })\r\n    }\r\n\r\n    __cursorPos = 0\r\n    __cursorPosListeners = []\r\n    get cursorPos() {\r\n        return this.__cursorPos\r\n    }\r\n    set cursorPos(val: number): void {\r\n        this.__cursorPos = val\r\n        this.__cursorPosListeners.forEach((cb) => setTimeout(() => cb(val), 1))\r\n    }\r\n\r\n    addCursorPosListener(cb: (event: mixed) => void): void {\r\n        this.__cursorPosListeners.push(cb)\r\n    }\r\n\r\n    getContainerOffset(container: HTMLElement): number {\r\n        let nodes: Array<any> = Array.from(this.childNodes)\r\n        while (nodes.filter((node) => node.childNodes.length).length) {\r\n            nodes = nodes\r\n                .map((el: Node) =>\r\n                    el.nodeName === '#text' || el.nodeName === 'BR'\r\n                        ? [el]\r\n                        : Array.from(el.childNodes)\r\n                )\r\n                .flat(Infinity)\r\n        }\r\n\r\n        let offset = 0\r\n        for (let node of nodes) {\r\n            if (node === container) break\r\n            offset += node.length || 1\r\n        }\r\n\r\n        return offset\r\n    }\r\n\r\n    getContainerAtOffset(offset: number): { line: Node, n: number } {\r\n        let nodes: Array<any> = Array.from(this.childNodes)\r\n        while (nodes.filter((node) => node.childNodes.length).length) {\r\n            nodes = nodes\r\n                .map((el: Node) =>\r\n                    el.nodeName === '#text' || el.nodeName === 'BR'\r\n                        ? [el]\r\n                        : Array.from(el.childNodes)\r\n                )\r\n                .flat(Infinity)\r\n        }\r\n\r\n        let lastNode: Node | void = undefined\r\n        let x = 0\r\n        for (let node of nodes) {\r\n            if (node.nodeName == 'BR') {\r\n                x += 1\r\n                continue\r\n            }\r\n            if (node.nodeName !== '#text') {\r\n                if (!node.firstChild) continue\r\n                node = node.firstChild\r\n            }\r\n            lastNode = node\r\n            if (x + (node.length || 1) >= offset) break\r\n            x += node.length || 1\r\n        }\r\n        return { line: lastNode || nodes[0], n: x }\r\n    }\r\n\r\n    setCursorPos(offset: number): void {\r\n        if (document.activeElement !== this) return\r\n        let containerData = this.getContainerAtOffset(offset)\r\n        let node = containerData.line\r\n        let n = containerData.n\r\n\r\n        if (!node) return\r\n\r\n        if (node.firstChild) node = node.firstChild\r\n\r\n        try {\r\n            var range = window.getSelection().getRangeAt(0)\r\n        } catch (err) {\r\n            return\r\n        }\r\n        console.log(offset - n, offset, n)\r\n        range.setEnd(node, offset - n)\r\n        range.setStart(node, offset - n)\r\n        this.cursorPos = offset\r\n    }\r\n\r\n    getCursorPos(): number {\r\n        var caretOffset = 0\r\n        try {\r\n            var range = window.getSelection().getRangeAt(0)\r\n        } catch (err) {\r\n            return 0\r\n        }\r\n        var selected = range.toString().length\r\n        var preCaretRange = range.cloneRange()\r\n\r\n        preCaretRange.selectNodeContents(this)\r\n        preCaretRange.setEnd(range.endContainer, range.endOffset)\r\n        caretOffset = preCaretRange.toString().length - selected\r\n\r\n        const brCount = Array.from(preCaretRange.cloneContents().childNodes)\r\n            .map((el: HTMLElement) =>\r\n                el.nodeName === '#text'\r\n                    ? []\r\n                    : Array.from(el.querySelectorAll('*'))\r\n            )\r\n            .flat(Infinity)\r\n            .filter((el: any) => el.nodeName === 'BR').length\r\n        caretOffset += brCount\r\n\r\n        return caretOffset\r\n    }\r\n\r\n    getSelection(): CustomSelection {\r\n        let range\r\n        try {\r\n            range = window.getSelection().getRangeAt(0)\r\n            // console.log('Original range:', range)\r\n            // return range\r\n        } catch (err) {\r\n            return {\r\n                startOffset: 0,\r\n                endOffset: 0,\r\n                startContainer: this,\r\n                endContainer: this,\r\n                collapsed: true,\r\n                toString: () => '',\r\n            }\r\n        }\r\n        let result: CustomSelection = {}\r\n        let firstOffset = this.getContainerOffset(range.startContainer)\r\n        let secondOffset = this.getContainerOffset(range.endContainer)\r\n\r\n        // console.log('Offsets:', firstOffset, secondOffset)\r\n\r\n        result.toString = () => range.toString()\r\n\r\n        result.collapsed = range.collapsed\r\n\r\n        result.startContainer = range.startContainer\r\n        result.startOffset = range.startOffset + firstOffset\r\n\r\n        result.endContainer = range.endContainer\r\n        result.endOffset = range.endOffset + secondOffset\r\n\r\n        return result\r\n    }\r\n}\r\n\r\ncustomElements.define('baka-editable', Editable)\r\n","// @flow\r\n\r\nimport Document from './markdown_document'\r\nimport Editable from './editable'\r\nimport BakaLink from './baka_link'\r\n\r\nclass BakaEditor extends HTMLElement {\r\n    template = `<div id=\"wrapper\">\r\n        <div id=\"buttons\">\r\n            <a href=\"#\" id=\"bold\" tabindex=\"-1\" class=\"\">B</a>\r\n            <a href=\"#\" id=\"italic\" tabindex=\"-1\" class=\"\">I</a>\r\n            <a href=\"#\" id=\"strike\" tabindex=\"-1\" class=\"\">S</a>\r\n            <a href=\"#\" id=\"underline\" tabindex=\"-1\" class=\"\">U</a>\r\n            <a href=\"#\" id=\"monospace\" tabindex=\"-1\" class=\"\">M</a>\r\n        </div>\r\n        <div id=\"placeholder\">Type: Echo!</div>\r\n        <baka-editable id=\"editor\" />\r\n    </div>`\r\n\r\n    debug = false\r\n\r\n    elms: {\r\n        placeholder: HTMLElement,\r\n    } = {}\r\n    stylesOverride = {}\r\n    outputContainer: HTMLElement | void | null\r\n    originalOutputContainer: HTMLElement | void | null\r\n\r\n    static get observedAttributes() {\r\n        return ['placeholder', 'output', 'originaloutput', 'debug']\r\n    }\r\n\r\n    attributeChangedCallback(name, oldValue, newValue) {\r\n        switch (name) {\r\n            case 'debug':\r\n                this.debug = this.getAttribute('debug') !== null\r\n            case 'placeholder':\r\n                if (!this.elms.placeholder) break\r\n                this.elms.placeholder.innerHTML = newValue\r\n                break\r\n            case 'output':\r\n                this.outputContainer = document.querySelector(\r\n                    this.getAttribute('output')\r\n                )\r\n                break\r\n            case 'originaloutput':\r\n                this.originalOutputContainer = document.querySelector(\r\n                    this.getAttribute('originaloutput')\r\n                )\r\n                break\r\n        }\r\n    }\r\n\r\n    connectedCallback() {\r\n        this.innerHTML = this.template\r\n\r\n        this.debug = this.getAttribute('debug') !== null\r\n\r\n        this.outputContainer = document.querySelector(\r\n            this.getAttribute('output')\r\n        )\r\n\r\n        this.elms.wrapper = this.querySelector('#wrapper')\r\n        this.elms.editor = this.querySelector('#editor')\r\n\r\n        this.elms.placeholder = this.querySelector('#placeholder')\r\n        if (this.getAttribute('placeholder'))\r\n            this.elms.placeholder.innerHTML = this.getAttribute('placeholder')\r\n\r\n        this.document = new Document()\r\n        this.document.addEventListener('update', this.onTextUpdate.bind(this))\r\n        this.document.addEventListener('update', this.logger.bind(this))\r\n\r\n        this.initEditor()\r\n        this.initButtons()\r\n\r\n        this.logger({ type: 'INIT' })\r\n    }\r\n\r\n    updateButtons() {\r\n        let range = this.elms.editor.getSelection()\r\n        let offset = range.startOffset\r\n        const styles = range.collapsed\r\n            ? Object.keys(this.document.getStylesAtOffset(offset))\r\n            : this.document.getStylesAtRange(range.startOffset, range.endOffset)\r\n\r\n        for (let styleName in this.stylesOverride) {\r\n            if (\r\n                styles.indexOf(styleName) >= 0 &&\r\n                !this.stylesOverride[styleName]\r\n            ) {\r\n                styles.splice(styles.indexOf(styleName), 1)\r\n            }\r\n            if (\r\n                styles.indexOf(styleName) < 0 &&\r\n                this.stylesOverride[styleName]\r\n            ) {\r\n                styles.push(styleName)\r\n            }\r\n        }\r\n\r\n        this.elms.wrapper\r\n            .querySelectorAll('#buttons > a')\r\n            .forEach((el) => el.classList.remove('active'))\r\n        styles.forEach((style) => {\r\n            if (!(style in this.elms.buttons)) return\r\n            this.elms.buttons[style].classList.add('active')\r\n        })\r\n    }\r\n\r\n    initButtons() {\r\n        this.elms.editor.addCursorPosListener(() => {\r\n            this.stylesOverride = {}\r\n            this.updateButtons()\r\n        })\r\n        this.elms.buttons = {\r\n            wrapper: this.elms.wrapper.querySelector('#buttons'),\r\n            bold: this.elms.wrapper.querySelector('#buttons #bold'),\r\n            italic: this.elms.wrapper.querySelector('#buttons #italic'),\r\n            strike: this.elms.wrapper.querySelector('#buttons #strike'),\r\n            underline: this.elms.wrapper.querySelector('#buttons #underline'),\r\n            monospace: this.elms.wrapper.querySelector('#buttons #monospace'),\r\n        }\r\n\r\n        const onButtonClick = (buttonName, e) => {\r\n            e.preventDefault()\r\n            this.elms.editor.focus()\r\n\r\n            const range = this.elms.editor.getSelection()\r\n            if (!range.collapsed) {\r\n                const styles = this.document.getStylesAtRange(\r\n                    range.startOffset,\r\n                    range.endOffset\r\n                )\r\n                if (styles.indexOf(buttonName) >= 0) {\r\n                    this.document.unmark(\r\n                        buttonName,\r\n                        range.startOffset,\r\n                        range.endOffset\r\n                    )\r\n                } else {\r\n                    this.document.mark(\r\n                        buttonName,\r\n                        range.startOffset,\r\n                        range.endOffset\r\n                    )\r\n                }\r\n                this.elms.editor.cursorPos = range.endOffset\r\n                this.elms.editor.setCursorPos(range.endOffset)\r\n                return\r\n            }\r\n\r\n            const button = this.elms.buttons[buttonName]\r\n            const isActive = button.classList.contains('active')\r\n\r\n            this.stylesOverride[buttonName] = !isActive\r\n        }\r\n\r\n        for (let styleName in this.document.styles) {\r\n            if (!(styleName in this.elms.buttons)) continue\r\n            this.elms.buttons[styleName].addEventListener('click', (e) =>\r\n                onButtonClick(styleName, e)\r\n            )\r\n        }\r\n        window.document.addEventListener('click', () => {\r\n            this.updateButtons()\r\n        })\r\n    }\r\n\r\n    logger(historyEvent) {\r\n        if (!this.debug) return\r\n        console.log(\r\n            '\\n%cFired event %s\\n%c%s\\n%s\\n%c%s\\n%s%o\\n%s%o\\n',\r\n            ['font-weight: bold', 'margin-bottom: 6px'].join(';'),\r\n            historyEvent.type.toUpperCase(),\r\n            ['color: rgba(0,0,0,1)', 'padding-bottom: 6px'].join(';'),\r\n            this.document.text.slice(0, this.elms.editor.cursorPos) +\r\n                '][' +\r\n                this.document.text.slice(\r\n                    this.elms.editor.cursorPos,\r\n                    this.document.text.length\r\n                ),\r\n            this.document.toHtml(),\r\n            ['color: rgba(0,0,0,.9)', 'line-height: 1.4em'].join(';'),\r\n            `Document length: ${this.document.text.length}; Cursor position: ${this.elms.editor.cursorPos}`,\r\n            'Event details:',\r\n            historyEvent,\r\n            'Styles:',\r\n            this.document.styles\r\n        )\r\n    }\r\n\r\n    setText(text) {\r\n        this.elms.editor.cursorPos = 0\r\n        this.document.setText(text)\r\n    }\r\n\r\n    onTextUpdate() {\r\n        if (this.document.text.length) {\r\n            this.elms.placeholder.classList.add('invisible')\r\n        } else {\r\n            this.elms.placeholder.classList.remove('invisible')\r\n        }\r\n\r\n        this.elms.editor.innerHTML = this.document.toHtml()\r\n        if (this.outputContainer)\r\n            this.outputContainer.value = this.document.getFinalHtml()\r\n        if (this.originalOutputContainer)\r\n            this.originalOutputContainer.value = this.document.text\r\n        this.elms.editor.setCursorPos(this.elms.editor.cursorPos)\r\n        this.dispatchEvent(\r\n            new CustomEvent('change', {\r\n                detail: {\r\n                    original: this.document.text,\r\n                    html: this.document.getFinalHtml(),\r\n                },\r\n            })\r\n        )\r\n    }\r\n\r\n    initEditor() {\r\n        if (this.document.text.length) {\r\n            this.elms.placeholder.classList.add('invisible')\r\n        } else {\r\n            this.elms.placeholder.classList.remove('invisible')\r\n        }\r\n\r\n        this.elms.editor.initIO(this.document)\r\n    }\r\n}\r\n\r\ncustomElements.define('baka-editor', BakaEditor)\r\n","// @flow\r\n\r\nimport Document from './document'\r\n\r\nexport default class MarkdownDocument extends Document {\r\n    // text = '```Hello, world!\\nIts me, Dio!\\n```'\r\n    // text = '*Привет*, **мир**!\\n\\n***Сегодня*** __я__ ~~делаю~~ `маркдаун`!'\r\n\r\n    // text = 'as\\ndf'\r\n    // text = '> Привет!\\n> Мир!\\nТест'\r\n    // text = `*hello ~~world~~*`\r\n\r\n    set styles(value: any) {}\r\n    get styles() {\r\n        let ranges: {\r\n            [string]: [number, number][],\r\n        } = {\r\n            bold: [],\r\n            italic: [],\r\n            underline: [],\r\n            strike: [],\r\n            monospace: [],\r\n            header_first: [],\r\n            header_second: [],\r\n            code: [],\r\n            quote: [],\r\n            service: [],\r\n            link: [],\r\n            image: [],\r\n            image_title: [],\r\n            link_title: [],\r\n        }\r\n\r\n        const process = (styleNames, regexp, n) => {\r\n            this.text.replace(regexp, (fullMatch, match, index) => {\r\n                let start = index + n\r\n                let end = index + fullMatch.length - n\r\n                for (let styleName of styleNames) {\r\n                    ranges[styleName].push([start, end])\r\n                }\r\n                ranges.service.push([start - n, start])\r\n                ranges.service.push([end, end + n])\r\n                return match\r\n            })\r\n        }\r\n\r\n        const processOneLine = (styleNames, regexp, n) => {\r\n            this.text.replace(regexp, (fullMatch, match, index) => {\r\n                let start = index\r\n                let end = index + fullMatch.length\r\n                for (let styleName of styleNames) {\r\n                    ranges[styleName].push([start, end])\r\n                }\r\n                ranges.service.push([start, start + n])\r\n                return match\r\n            })\r\n        }\r\n\r\n        const processGroup = (styleNames, regexp, n) => {\r\n            this.text.replace(regexp, (fullMatch, match, index) => {\r\n                let start = index\r\n                let end = index + fullMatch.length\r\n                for (let styleName of styleNames) {\r\n                    let prevIndex = ranges[styleName].findIndex(\r\n                        (el) => el[1] + 1 === start\r\n                    )\r\n                    if (prevIndex < 0) {\r\n                        ranges[styleName].push([start, end])\r\n                        ranges.service.push([start, start + n])\r\n                        continue\r\n                    }\r\n                    ranges[styleName].splice(prevIndex, 1, [\r\n                        ranges[styleName][prevIndex][0],\r\n                        end,\r\n                    ])\r\n                }\r\n                ranges.service.push([start, start + n])\r\n            })\r\n        }\r\n\r\n        const processLinks = () => {\r\n            this.text.replace(\r\n                /(?<!!)\\[([^\\n\\r]*?)\\]\\(([^\\n\\r]+?)\\)/gm,\r\n                (fullMatch, title, link, index) => {\r\n                    ranges['service'].push([index, index + 1])\r\n                    ranges['service'].push([\r\n                        index + 1 + title.length,\r\n                        index + 1 + title.length + 1,\r\n                    ])\r\n                    ranges['link_title'].push([\r\n                        index + 1,\r\n                        index + 1 + title.length,\r\n                    ])\r\n\r\n                    let linkStart = index + 1 + title.length + 2\r\n                    let linkEnd = linkStart + link.length\r\n                    ranges['service'].push([linkStart - 1, linkStart])\r\n                    ranges['service'].push([linkEnd, linkEnd + 1])\r\n                    ranges['link'].push([linkStart, linkEnd])\r\n                }\r\n            )\r\n        }\r\n\r\n        const processImages = () => {\r\n            this.text.replace(\r\n                /\\!\\[([^\\n\\r]*?)\\]\\(([^\\n\\r]+?)\\)/gm,\r\n                (fullMatch, title, link, index) => {\r\n                    ranges['service'].push([index, index + 2])\r\n                    ranges['service'].push([\r\n                        index + 2 + title.length,\r\n                        index + 2 + title.length + 1,\r\n                    ])\r\n                    ranges['image_title'].push([\r\n                        index + 2,\r\n                        index + 2 + title.length,\r\n                    ])\r\n\r\n                    let linkStart = index + 2 + title.length + 2\r\n                    let linkEnd = linkStart + link.length\r\n                    ranges['service'].push([linkStart - 1, linkStart])\r\n                    ranges['service'].push([linkEnd, linkEnd + 1])\r\n                    ranges['image'].push([linkStart, linkEnd])\r\n                }\r\n            )\r\n        }\r\n\r\n        processLinks()\r\n        processImages()\r\n\r\n        process(\r\n            ['bold'],\r\n            /(?<!\\*|\\\\\\*)\\*{2}[^*\\n]([\\s\\S]+?)[^*]\\*{2}(?!\\*|\\\\)/gm,\r\n            2\r\n        )\r\n        process(['italic'], /((?<!\\*|\\\\)\\*[^*\\n][\\s\\S]+?[^*|\\\\]\\*(?!\\*))/gm, 1)\r\n        process(\r\n            ['bold', 'italic'],\r\n            /(?<!\\*|\\\\)\\*{3}[^*\\n]([\\s\\S]+?)[^*|\\\\]\\*{3}(?!\\*)/gm,\r\n            3\r\n        )\r\n\r\n        process(['underline'], /__(.+?)__/gm, 2)\r\n        process(['strike'], /~~(.+?)~~/gm, 2)\r\n\r\n        process(['code'], /```([^`]+?)```/gm, 3)\r\n        process(['quote'], /(?<!`|\\\\)``([^`]+?)``/gm, 2)\r\n        process(['monospace'], /(?<!`|\\\\)`([^`\\n\\r]+?)`/gm, 1)\r\n\r\n        processOneLine(['header_first'], /(?<!#)# ([^\\r\\n]+)/gm, 2)\r\n        processOneLine(['header_second'], /## ([^\\r\\n]+)/gm, 3)\r\n\r\n        // processGroup(['quote'], /> ([^\\n\\r]+)/gm, 2)\r\n\r\n        return {\r\n            bold: {\r\n                openTag: '<b>',\r\n                closeTag: '</b>',\r\n                ranges: ranges.bold,\r\n            },\r\n            italic: {\r\n                openTag: '<i>',\r\n                closeTag: '</i>',\r\n                ranges: ranges.italic,\r\n            },\r\n            underline: {\r\n                openTag: '<u>',\r\n                closeTag: '</u>',\r\n                ranges: ranges.underline,\r\n            },\r\n            strike: {\r\n                openTag: '<s>',\r\n                closeTag: '</s>',\r\n                ranges: ranges.strike,\r\n            },\r\n            monospace: {\r\n                openTag: '<span class=\"monospace\">',\r\n                closeTag: '</span>',\r\n                ranges: ranges.monospace,\r\n            },\r\n            code: {\r\n                openTag: '<span class=\"code\">',\r\n                closeTag: '</span>',\r\n                ranges: ranges.code,\r\n            },\r\n            header_first: {\r\n                openTag: '<h1>',\r\n                closeTag: '</h1>',\r\n                ranges: ranges.header_first,\r\n            },\r\n            header_second: {\r\n                openTag: '<h2>',\r\n                closeTag: '</h2>',\r\n                ranges: ranges.header_second,\r\n            },\r\n            quote: {\r\n                openTag: '<blockquote>',\r\n                closeTag: '</blockquote>',\r\n                ranges: ranges.quote,\r\n            },\r\n            link: {\r\n                openTag: '<baka-link class=\"link\">',\r\n                closeTag: '</baka-link>',\r\n                ranges: ranges.link,\r\n            },\r\n            link_title: {\r\n                openTag: '<span class=\"service_link_title\">',\r\n                closeTag: '</span>',\r\n                ranges: ranges.link_title,\r\n            },\r\n            image: {\r\n                openTag: '<baka-link class=\"image_link\">',\r\n                closeTag: '</baka-link>',\r\n                ranges: ranges.image,\r\n            },\r\n            image_title: {\r\n                openTag: '<span class=\"service_image_title\">',\r\n                closeTag: '</span>',\r\n                ranges: ranges.image_title,\r\n            },\r\n            service: {\r\n                openTag: '<span class=\"service\">',\r\n                closeTag: '</span>',\r\n                ranges: ranges.service,\r\n            },\r\n        }\r\n    }\r\n\r\n    getStylesAtOffset(offset: number) {\r\n        let styles: {\r\n            [string]: [number, number],\r\n        } = {}\r\n        for (let styleName in this.styles) {\r\n            for (let i = 0; i < this.styles[styleName].ranges.length; i++) {\r\n                let range = this.styles[styleName].ranges[i]\r\n                if (!(range[0] <= offset && range[1] >= offset)) continue\r\n                styles[styleName] = range\r\n            }\r\n        }\r\n        return styles\r\n    }\r\n\r\n    getStylesAtRange(start: number, end: number) {\r\n        let styles: string[] = []\r\n        for (let styleName in this.styles) {\r\n            for (let i = 0; i < this.styles[styleName].ranges.length; i++) {\r\n                let range: [number, number] = this.styles[styleName].ranges[i]\r\n                if (\r\n                    !(\r\n                        (\r\n                            (range[0] >= start && range[0] <= end) || // Начало в выделении\r\n                            (range[1] >= start && range[1] <= end) || // Конец в выделении\r\n                            (range[0] <= start && range[1] >= end)\r\n                        ) // Выделение между началом и концом\r\n                    )\r\n                )\r\n                    continue\r\n                styles.push(styleName)\r\n            }\r\n        }\r\n        return styles\r\n    }\r\n\r\n    getFinalHtml() {\r\n        const link_titles = []\r\n        this.text.replace(\r\n            /(?<!!)\\[([^\\n\\r]*?)\\]\\(([^\\n\\r]+?)\\)/gm,\r\n            (full, title, link) => {\r\n                console.log(title, link)\r\n                link_titles.push(title ? title : link)\r\n            }\r\n        )\r\n\r\n        const image_titles = []\r\n        this.text.replace(\r\n            /!\\[([^\\n\\r]*?)\\]\\(([^\\n\\r]+?)\\)/gm,\r\n            (full, title, link) => {\r\n                console.log(title, link)\r\n                image_titles.push(title ? title : '')\r\n            }\r\n        )\r\n\r\n        let html = this.toHtml()\r\n\r\n        let linkCounter = -1\r\n        html = html.replace(\r\n            /<baka-link class=\"link\">(.+)<\\/baka-link>/gm,\r\n            (full, link) => {\r\n                console.log(full, link)\r\n                linkCounter++\r\n                return `<a href=\"${link}\" target=\"_blank\">${link_titles[linkCounter]}</a>`\r\n            }\r\n        )\r\n\r\n        let imageCounter = -1\r\n        html = html.replace(\r\n            /<baka-link class=\"image_link\">(.+)<\\/baka-link>/gm,\r\n            (full, link) => {\r\n                console.log(full, link)\r\n                linkCounter++\r\n                return `<img src=\"${link}\" title=\"${image_titles[linkCounter]}\" />`\r\n            }\r\n        )\r\n\r\n        html = html.replace(/\\n/gm, '').replace(/\\r/gm, '')\r\n        return html.replace(\r\n            /<span class=[\"']service[_]*.*?[\"']>(.+?)<\\/span>/gm,\r\n            ''\r\n        )\r\n    }\r\n}\r\n"],"sourceRoot":""}